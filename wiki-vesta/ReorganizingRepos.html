<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>ReorganizingRepos - Vesta Wiki</title>
<script type="text/javascript" src="moin_static199/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="moin_static199/vesta/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="moin_static199/vesta/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="moin_static199/vesta/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="moin_static199/vesta/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="moin_static199/vesta/css/msie.css">
<![endif]-->


<link rel="alternate" title="Vesta Wiki: ReorganizingRepos" href="ReorganizingRepos%3Fdiffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=ReorganizingRepos&amp;ddiffs=1.html" type="application/rss+xml">


<link rel="Start" href="FrontPage.html">
<link rel="Alternate" title="Wiki Markup" href="ReorganizingRepos%3Faction=raw.html">
<link rel="Alternate" media="print" title="Print View" href="ReorganizingRepos%3Faction=print.html">
<link rel="Appendix" title="mirror-legacy-version.pl" href="ReorganizingRepos%3Faction=AttachFile&amp;do=view&amp;target=mirror-legacy-version.pl.html">
<link rel="Search" href="FindPage.html">
<link rel="Index" href="TitleIndex.html">
<link rel="Glossary" href="WordIndex.html">
<link rel="Help" href="HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr">

<div id="header">

<form id="searchform" method="get" action="ReorganizingRepos.html">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="FrontPage.html"><img src="wiki/vesta/img/1line.png" alt="Vesta" height=44 width=202></a></div>
<div id="locationline">

<ul id="pagelocation">
<li><a href="ReorganizingRepos.html">ReorganizingRepos</a></li>
</ul>

</div>
</div>

<div id="sidebar">
<div class="sidepanel">
<h1>Wiki</h1>

<ul id="navibar">
<li class="wikilink"><a href="RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a href="FindPage.html">FindPage</a></li><li class="wikilink"><a href="HelpContents.html">HelpContents</a></li><li class="current"><a href="ReorganizingRepos.html">ReorganizingRepos</a></li>
</ul>

</div>
<div class="sidepanel">
<h1>User</h1>
<ul id="username"><li><a href="ReorganizingRepos%3Faction=login.html" id="login" rel="nofollow">Login</a></li></ul>
</div>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="ReorganizingRepos.html#Reorganizing_Repositories">Reorganizing Repositories</a></li><li>
<a href="ReorganizingRepos.html#Reasons_for_Renaming_or_Deleting_Repos_Dirs">Reasons for Renaming or Deleting Repos Dirs</a><ol><li>
<a href="ReorganizingRepos.html#Typo_on_vmkdir_or_vcreate">Typo on vmkdir or vcreate</a></li><li>
<a href="ReorganizingRepos.html#Splitting_up_packages">Splitting up packages</a></li><li>
<a href="ReorganizingRepos.html#Refactoring">Refactoring</a></li><li>
<a href="ReorganizingRepos.html#Packages_Becoming_Obsolete">Packages Becoming Obsolete</a></li></ol></li><li>
<a href="ReorganizingRepos.html#Current_Options">Current Options</a><ol><li>
<a href="ReorganizingRepos.html#Create_New_Dirs">Create New Dirs</a></li><li>
<a href="ReorganizingRepos.html#Number_Your_Root_Dir">Number Your Root Dir</a></li></ol></li><li>
<a href="ReorganizingRepos.html#Other_Ideas">Other Ideas</a><ol><li>
<a href="ReorganizingRepos.html#Optionally_Make_Ghosts_Invisible">Optionally Make Ghosts Invisible</a></li><li>
<a href="ReorganizingRepos.html#Don.27t_.22Freeze.22_Until_Needed">Don't &quot;Freeze&quot; Until Needed</a></li><li>
<a href="ReorganizingRepos.html#Mount_A_Historical_View_of_the_Repository">Mount A Historical View of the Repository</a></li><li>
<a href="ReorganizingRepos.html#Transparently_Follow_Renames">Transparently Follow Renames</a></li><li>
<a href="ReorganizingRepos.html#Transparently_Re-write_Old_SDL_Imports">Transparently Re-write Old SDL Imports</a></li><li>
<a href="ReorganizingRepos.html#Unrelated:_Tracking_Renames_Between_Versions">Unrelated: Tracking Renames Between Versions</a></li></ol></li></ol></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
<h1 id="Reorganizing_Repositories">Reorganizing Repositories</h1>
<span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line862">Repository &quot;appendable directories&quot; (those below <tt>/vesta</tt>, both &quot;package-parents&quot; created with <tt>mkdir</tt> or <tt>vmkdir</tt>, and &quot;packages&quot; created with <tt>vcreate</tt>) and &quot;immutable directories&quot; (those created with <tt>vadvance</tt> and <tt>vcheckin</tt>) can never be renamed.  They can be deleted, but they leave behind <a class="http" href="../vesta/doc/man/html/vesta-intro.1.html#ghost">ghosts</a>.  (See: <a href="RepositoryRules.html">RepositoryRules</a>.) <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">Essentially, when you create something under <tt>/vesta</tt> (a directory, a package, a version), it's <em>immortal</em>.  Versions, once created, are <em>frozen</em> forever. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">There are two main motivations for these restrictions: <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><ol type="1"><li><p class="line891"><strong>Build repeatability.</strong>  In order for a build to do precisely the same thing in the future that it does now, once a version is created, it must always refer to the same contents.  So, once you create <tt>/vesta/example.com/dir/pkg/1</tt>, that version must always have the same contents.  If you could rename <tt>/vesta/example.com/dir/pkg</tt> to <tt>/vesta/example.com/otherdir/otherpkg</tt>, your build descriptions would still refer to the old name (via an <a class="http" href="../vesta/doc/sdl-ref/models.html#import">import</a>), and you wouldn't be able to repeat past builds.  If you could delete <tt>/vesta/example.com/dir</tt> without leaving behind a ghost, you could re-create <tt>/vesta/example.com/dir/pkg/1</tt> with different contents, which would change the result of builds you had created in the past. <span class="anchor" id="line-12"></span></li><li><p class="line891"><strong>Replication invariance.</strong>  Just as <tt>/vesta/example.com/dir/pkg/1</tt> is supposed to have the same contents for all time in the repository where it is first created, it's also supposed to have the same contents in any repository you <a class="http" href="../vesta/doc/man/html/vrepl.1.html">replicate</a> it to.  If you could delete objects without leaving ghosts, you could replace <tt>/vesta/example.com/dir/pkg/1</tt> in one repository and leave the old contents in another repository.  (For more on this see: <a class="http" href="../vesta/doc/man/html/vrepl.1.html#Vesta_Replication">&quot;Vesta Replication Design&quot; in the vrepl(1) man page</a> and <a class="http" href="http://gatekeeper.research.compaq.com/pub/DEC/SRC/research-reports/abstracts/src-rr-172.html">Partial Replication in the Vesta Software Repository</a>.) <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ol><p class="line874">But the desire to rename or delete them remains, nonetheless. <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line867">
<h1 id="Reasons_for_Renaming_or_Deleting_Repos_Dirs">Reasons for Renaming or Deleting Repos Dirs</h1>
<span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line874">There are several common reasons why people want to delete or rename repository directories and packages. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line867">
<h2 id="Typo_on_vmkdir_or_vcreate">Typo on vmkdir or vcreate</h2>
<span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line862">Ie, you type <tt>vmkdir&nbsp;progrm</tt> when you meant <tt>vmkdir&nbsp;program</tt>. <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line867">
<h2 id="Splitting_up_packages">Splitting up packages</h2>
<span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line874">Since programs tend to get bigger over time, adding more souce files, packages tend to grow in file count.  Eventually one may want to split a package up into two or more separate packages. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line867">
<h2 id="Refactoring">Refactoring</h2>
<span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line874">This is just a general reorganization of dirs, packages, and files, for readability, or because the human team structure changed, or for many other reasons. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line867">
<h2 id="Packages_Becoming_Obsolete">Packages Becoming Obsolete</h2>
<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line874">Maybe some component of your design is no longer used.  You probably don't want to completely delete it (as old builds may refer to it), but maybe you don't want users to see it when looking through the contents of the repository. <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line874">(Really this is a sub-problem of both splitting up packages and refactoring.) <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867">
<h1 id="Current_Options">Current Options</h1>
<span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><p class="line867">
<h2 id="Create_New_Dirs">Create New Dirs</h2>
<span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line862">If you <tt>vmkdir&nbsp;progrm</tt> by accident, you can just say to yourself &quot;oops&quot; and <tt>vmkdir&nbsp;program</tt> and just live with both of those lying around, one of which you never use again.  You can <tt>vrm&nbsp;progrm</tt>, of course, but this still leaves <tt>progrm</tt> lying around as a ghost. <span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><p class="line867"><span class="anchor" id="number_root_dir"></span> <span class="anchor" id="line-45"></span>
<h2 id="Number_Your_Root_Dir">Number Your Root Dir</h2>
<span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line862">When you create the top-level dir of your tree, even the namespace, create it as <tt>project1.example.com</tt> instead of just <tt>project.example.com</tt> so that when you eventually want to refactor, you just move to <tt>project2.example.com</tt>.  A disadvantage of this approach is that, except for possibly <tt>old-version</tt> attributes, your new <tt>project2.example.com</tt> tree has lost connection to your old tree. <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line862">It's relatively easy to automate such a migration.  The <a class="attachment" href="ReorganizingRepos%3Faction=AttachFile&amp;do=view&amp;target=mirror-legacy-version.pl.html" title="">mirror-legacy-version.pl</a> script attached to this page is an example of one way to do a simple migration to a new top-level directory (though it won't do any re-organization, so probably isn't appropriate for most uses). <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line862">A potential problem with this is that paths to objects below <tt>/vesta</tt> may get hard-coded into various files (scripts, replicator instructions, weeder instructions, etc.).  The <a class="attachment" href="ReorganizingRepos%3Faction=AttachFile&amp;do=view&amp;target=mirror-legacy-version.pl.html" title="">mirror-legacy-version.pl</a> script only helps with re-writing SDL imports. <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line867">
<h1 id="Other_Ideas">Other Ideas</h1>
<span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line867">
<h2 id="Optionally_Make_Ghosts_Invisible">Optionally Make Ghosts Invisible</h2>
<span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line862">An idea that's been suggested in the past (and has <a class="https" href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1075296&amp;group_id=34164&amp;atid=410430">a tracker entry</a>) is to make ghosts invisible when listing a directory through the NFS interface.  This could be implemented without too much difficulty.  The ghosts would still exist and still perform their essential function of preventing names from being recreated with different contents.  However, they wouldn't show up when listing a directory. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line874">This would probably be affected by an attribute which would either be required to hide a ghost or could be set to make a ghost visible again. <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line874">We could make this applicable to non-ghosts as well, which would make it possible to hide an obsolete package but leave it in the repository so that old builds could use it. <span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><p class="line862">An alternative suggestion is implementing a <a class="https" href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1076227&amp;group_id=34164&amp;atid=410430">a Vesta-specific vls command</a> that can optionally hide ghosts. <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line867">
<h2 id="Don.27t_.22Freeze.22_Until_Needed">Don't &quot;Freeze&quot; Until Needed</h2>
<span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><p class="line862">In <a class="http" href="http://www.scooter.cx/~mozbot/%23vesta-20050812-070001.xml#johnvkxi:2005-08-12T03:18:51Z">the conversation which prompted the creation of this page</a>, <a href="JohnVk.html">JohnVk</a> <a class="http" href="http://www.scooter.cx/~mozbot/%23vesta-20050812-070001.xml#johnvkxi:2005-08-12T03:18:51Z">suggested the idea  of allowing changes to appendable directories until they need to be &quot;frozen&quot;</a>.  There are two obvious times when you would need to &quot;freeze&quot; something: <span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><ol type="1"><li>When a source is first used by a build <span class="anchor" id="line-70"></span></li><li>When a source is replicated to a peer repository <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span></li></ol><p class="line874">It seems like this would be difficult to implement, and would actually be more difficult for users to understand than the current rules.  They would have to have some way to find out whether something can be renamed, and would probably have difficulty understanding why something suddenly changes from being renameable/replaceable to no being frozen/immortal. <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line867">
<h2 id="Mount_A_Historical_View_of_the_Repository">Mount A Historical View of the Repository</h2>
<span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line867"><a href="AdamMartin.html">AdamMartin</a> <a class="http" href="http://www.scooter.cx/~mozbot/%23vesta-20050818-070000.xml#ircsucks:2005-08-17T14:17:51Z">suggested the idea of mounting the repository as it was at some point in the past</a>.  I (<a href="KenSchalk.html">KenSchalk</a>) <a class="http" href="http://www.scooter.cx/~mozbot/%23vesta-20050818-070000.xml#ircsucks:2005-08-17T14:17:51Z">responded later on IRC with a few reasons why this would be difficult</a>. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line874">Really I'm not clear on how much utility this would have, as it would mostly help with the behavior of scripts/programs which are not part of a Vesta build but which want to access the repository via NFS or look at attributes. <span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line867">
<h2 id="Transparently_Follow_Renames">Transparently Follow Renames</h2>
<span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line867"><a class="nonexistent" href="JimHuggins.html">JimHuggins</a> suggests: <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><ul><li style="list-style-type:none">Keep a database of old and new package positions.  If an import is not found, the database would be used to find it in case it was moved.  Of course, this would mean we would have to reserve the name so a new package with the same name isn't created in the old position.  The idea here is that someone is unhappy with the package (not needed anymore) or it's position and wouldn't really care to create the same name in the same position again. Perhaps, if they did we could just ask if they would like to move the package back. <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span></li></ul><p class="line862">This seems problematic to me (<a href="KenSchalk.html">KenSchalk</a>) for several reasons: <span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><ol type="1"><li>It makes the evaluator's behavior dependent upon data which changes over time.  Even though the intent is not to introduce anything which could break repeatability, this seems inherently unwise. <span class="anchor" id="line-89"></span></li><li>It requires a new query-able database that's part of the repository's stable, transactional data store.  This definitely has to be made part of the repository, as changes to it would have to be atomic with the , but it's a non-trivial amount of work just to add this database. <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span></li></ol><p class="line862">A better option for supporting this would be to have SDL refer to its imports not by a path below <tt>/vesta</tt>, but by something persistent (like the fingerprint of the immutable directory).  This would essentially mean treating the path to a version (<tt>vesta/vestasys.org/vesta/release/12</tt>) as a <a class="http" href="http://www.erights.org/elib/capability/pnml.html">&quot;pet name&quot;</a> for a more permanent referent, like it's fingerprint (<tt>e8ca04dd4c895ee654ef9ceaec291e39</tt>).  The down-side to this approach would be that SDL imports would become far less readable: <span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><p class="line867"><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><pre><span class="anchor" id="line-1"></span>from e8ca04dd4c895ee654ef9ceaec291e39 import
<span class="anchor" id="line-2"></span>  vesta_release_12 = build.ves;</pre><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line862">This would also make the output of <a class="http" href="../vesta/doc/man/html/vimports.1.html">vimports</a> unreadable, and would probably completely break <a class="http" href="../vesta/doc/man/html/vupdate.1.html">vupdate</a>. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><p class="line874">It's probably better to just leave the package in its original position even after migrating to using it at the new position. <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><p class="line874">Having said all this, there are some other reason why it would be very helpful to have an accessible data structure which stores the DAG of versions for a package.  That's not quite what Jim said, but such a data structure would probably include information about where all copies of the exact same version exist, which could be used for a purpose like this. <span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><p class="line867">
<h2 id="Transparently_Re-write_Old_SDL_Imports">Transparently Re-write Old SDL Imports</h2>
<span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><p class="line867"><a class="nonexistent" href="JimHuggins.html">JimHuggins</a> suggests: <span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><ul><li style="list-style-type:none">Actually have Vesta change the contents of existing versions in vesta to effectively change the import paths of any sdl code importing this old path.  This wouldn't actually create new versions just change the old ones.  Yeah I know .. .scary stuff  but once done, you can completely forget about the fact you moved a package.  I guess the fun part here is remote vesta sites importing the package.  I can see us searching our entire repos but to also ensure all other repos's don't use it as well  not sure if that is possible / feasible thing to do. <span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span></li></ul><p class="line862">My (<a href="KenSchalk.html">KenSchalk</a>) instinct is to reject any idea that involves re-writing history.  I like the previous idea more. <span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><p class="line867">
<h2 id="Unrelated:_Tracking_Renames_Between_Versions">Unrelated: Tracking Renames Between Versions</h2>
<span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line862">There's <a class="https" href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1195227&amp;group_id=34164&amp;atid=410430">an RFE about automatically handling tracking of renames</a>, but this is about a different problem: keeping track of renames of files/directories <em>within</em> a package (i.e. the changes from one version to the next).  It has nothing to do with renaming in appendable directories. <span class="anchor" id="line-115"></span><span class="anchor" id="bottom"></span></div>
<div id="pagebottom"></div>
</div>


<div id="footer">
<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>
</html>

