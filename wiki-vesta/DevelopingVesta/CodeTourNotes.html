<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>DevelopingVesta/CodeTourNotes - Vesta Wiki</title>
<script type="text/javascript" src="moin_static199/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="../moin_static199/vesta/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="../moin_static199/vesta/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="../moin_static199/vesta/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/msie.css">
<![endif]-->


<link rel="alternate" title="Vesta Wiki: DevelopingVesta/CodeTourNotes" href="CodeTourNotes%3Fdiffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=DevelopingVesta%252FCodeTourNotes&amp;ddiffs=1.html" type="application/rss+xml">


<link rel="Start" href="FrontPage.html">
<link rel="Alternate" title="Wiki Markup" href="CodeTourNotes%3Faction=raw.html">
<link rel="Alternate" media="print" title="Print View" href="CodeTourNotes%3Faction=print.html">
<link rel="Up" href="DevelopingVesta.html">
<link rel="Appendix" title="autogenerated-0918f45ebc8c7f22912febacf6e1628ac6e80c5f.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-0918f45ebc8c7f22912febacf6e1628ac6e80c5f.png.html">
<link rel="Appendix" title="autogenerated-0c95b9c41cdd9214bb27cc97f26b18546673198f.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-0c95b9c41cdd9214bb27cc97f26b18546673198f.png.html">
<link rel="Appendix" title="autogenerated-0ccde9454e3faaed921fe18c32e5a950ef8956d1.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-0ccde9454e3faaed921fe18c32e5a950ef8956d1.png.html">
<link rel="Appendix" title="autogenerated-0d975847da11a283fdcea8516cba8b1b4999bfe9.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-0d975847da11a283fdcea8516cba8b1b4999bfe9.png.html">
<link rel="Appendix" title="autogenerated-0e087eb2db7e15d91899286c2158ea5643554de5.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-0e087eb2db7e15d91899286c2158ea5643554de5.png.html">
<link rel="Appendix" title="autogenerated-14518c4fc7075612aa6d11caf61e082df87d3dd1.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-14518c4fc7075612aa6d11caf61e082df87d3dd1.png.html">
<link rel="Appendix" title="autogenerated-14fdd03a5da17733a7c96990fc85d58dbbba02f3.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-14fdd03a5da17733a7c96990fc85d58dbbba02f3.png.html">
<link rel="Appendix" title="autogenerated-17fe471869200082b955ec68333707f63bdbd08e.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-17fe471869200082b955ec68333707f63bdbd08e.png.html">
<link rel="Appendix" title="autogenerated-1d61c30326f83f66ca18a4da59bee55b84744f70.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-1d61c30326f83f66ca18a4da59bee55b84744f70.png.html">
<link rel="Appendix" title="autogenerated-1e250d14d6e346b765f982656479b4a45eb7dc97.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-1e250d14d6e346b765f982656479b4a45eb7dc97.png.html">
<link rel="Appendix" title="autogenerated-26739546ce79d740815bccf0ac06224e71fa41e4.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-26739546ce79d740815bccf0ac06224e71fa41e4.png.html">
<link rel="Appendix" title="autogenerated-2f6a622069ca482a9786adc5c0d5240e707d3f8c.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-2f6a622069ca482a9786adc5c0d5240e707d3f8c.png.html">
<link rel="Appendix" title="autogenerated-3109f607e032abec877b1b7c2e9c926c613db27e.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-3109f607e032abec877b1b7c2e9c926c613db27e.png.html">
<link rel="Appendix" title="autogenerated-316ac9ce4cfe6e29ceec5f02cb9f8bde05ce1feb.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-316ac9ce4cfe6e29ceec5f02cb9f8bde05ce1feb.png.html">
<link rel="Appendix" title="autogenerated-3e1de62c2a8efc86d5de2ac27f31289113f1763b.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-3e1de62c2a8efc86d5de2ac27f31289113f1763b.png.html">
<link rel="Appendix" title="autogenerated-3ed333bd39477cfb198b644ced65f24173aa330f.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-3ed333bd39477cfb198b644ced65f24173aa330f.png.html">
<link rel="Appendix" title="autogenerated-422712b396854a25dea7a6b711a749cd4ab037e1.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-422712b396854a25dea7a6b711a749cd4ab037e1.png.html">
<link rel="Appendix" title="autogenerated-44bd338482302217a1bea9158975ea9d7716e444.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-44bd338482302217a1bea9158975ea9d7716e444.png.html">
<link rel="Appendix" title="autogenerated-4b9ca44f21bc9a8507f7f1d9a9f7946f647e7716.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-4b9ca44f21bc9a8507f7f1d9a9f7946f647e7716.png.html">
<link rel="Appendix" title="autogenerated-50989519724d90978cf4f9b36c7fda36cf63e503.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-50989519724d90978cf4f9b36c7fda36cf63e503.png.html">
<link rel="Appendix" title="autogenerated-582d6aac2d3bb0ae593a8ea8d09f49161c6abd23.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-582d6aac2d3bb0ae593a8ea8d09f49161c6abd23.png.html">
<link rel="Appendix" title="autogenerated-69ecbdf719310d8c572b0d67f2e66868be0fe5d5.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-69ecbdf719310d8c572b0d67f2e66868be0fe5d5.png.html">
<link rel="Appendix" title="autogenerated-70e0fb74df8a21859347490e9fe73f9b0f4b27b4.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-70e0fb74df8a21859347490e9fe73f9b0f4b27b4.png.html">
<link rel="Appendix" title="autogenerated-74ba97763c49962436fdf8c9c361669dc40c75f4.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-74ba97763c49962436fdf8c9c361669dc40c75f4.png.html">
<link rel="Appendix" title="autogenerated-7741cc310a7e84af583dd972408ad7c6790391d5.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-7741cc310a7e84af583dd972408ad7c6790391d5.png.html">
<link rel="Appendix" title="autogenerated-7d6a1e4de801199fbbdb31d7b78c6f18a79af391.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-7d6a1e4de801199fbbdb31d7b78c6f18a79af391.png.html">
<link rel="Appendix" title="autogenerated-8036df3268842af4dc7c8f77dd3bf97282430e88.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-8036df3268842af4dc7c8f77dd3bf97282430e88.png.html">
<link rel="Appendix" title="autogenerated-965192461890d8ead3da69092e238d35b9c621e2.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-965192461890d8ead3da69092e238d35b9c621e2.png.html">
<link rel="Appendix" title="autogenerated-a84c3e4c2855831eefc9acb5bf0460812cc1b1d6.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-a84c3e4c2855831eefc9acb5bf0460812cc1b1d6.png.html">
<link rel="Appendix" title="autogenerated-a88281c3956512bb5ce4d084a85b42bf3b968886.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-a88281c3956512bb5ce4d084a85b42bf3b968886.png.html">
<link rel="Appendix" title="autogenerated-aa31298f9ec9706822b55871f510e2eca8210c9d.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-aa31298f9ec9706822b55871f510e2eca8210c9d.png.html">
<link rel="Appendix" title="autogenerated-bcf2c463a9f1d35d4aa8ecddcc0173a6f8a36985.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-bcf2c463a9f1d35d4aa8ecddcc0173a6f8a36985.png.html">
<link rel="Appendix" title="autogenerated-bee9849a018392acf6ae13307ef162520b20103a.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-bee9849a018392acf6ae13307ef162520b20103a.png.html">
<link rel="Appendix" title="autogenerated-c2e598ddfdeaf0faca408e0793aed707bd73ae5c.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-c2e598ddfdeaf0faca408e0793aed707bd73ae5c.png.html">
<link rel="Appendix" title="autogenerated-c7b4654ac613a76930abd0a2f506de773110e65d.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-c7b4654ac613a76930abd0a2f506de773110e65d.png.html">
<link rel="Appendix" title="autogenerated-ca65a05e662794fe1f57d724fd09c2602124f23c.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-ca65a05e662794fe1f57d724fd09c2602124f23c.png.html">
<link rel="Appendix" title="autogenerated-d649742ff07969647639616b7aeb87a0e9158e49.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-d649742ff07969647639616b7aeb87a0e9158e49.png.html">
<link rel="Appendix" title="autogenerated-d7deb0ea68833f3b3657d35d72ee300282003917.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-d7deb0ea68833f3b3657d35d72ee300282003917.png.html">
<link rel="Appendix" title="autogenerated-daa91d7a6747c91581281f31f39b0b015a920d1d.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-daa91d7a6747c91581281f31f39b0b015a920d1d.png.html">
<link rel="Appendix" title="autogenerated-df9ab3f344b748b500c165f61b4b35c036d2e748.png" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=autogenerated-df9ab3f344b748b500c165f61b4b35c036d2e748.png.html">
<link rel="Appendix" title="delete.me.to.regenerate.images" href="CodeTourNotes%3Faction=AttachFile&amp;do=view&amp;target=delete.me.to.regenerate.images.html">
<link rel="Search" href="FindPage.html">
<link rel="Index" href="TitleIndex.html">
<link rel="Glossary" href="WordIndex.html">
<link rel="Help" href="HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr">

<div id="header">

<form id="searchform" method="get" action="CodeTourNotes.html">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="FrontPage.html"><img src="wiki/vesta/img/1line.png" alt="Vesta" height=44 width=202></a></div>
<div id="locationline">

<ul id="pagelocation">
<li><a href="DevelopingVesta.html">DevelopingVesta</a></li><li><a href="CodeTourNotes.html">CodeTourNotes</a></li>
</ul>

</div>
</div>

<div id="sidebar">
<div class="sidepanel">
<h1>Wiki</h1>

<ul id="navibar">
<li class="wikilink"><a href="RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a href="FindPage.html">FindPage</a></li><li class="wikilink"><a href="HelpContents.html">HelpContents</a></li><li class="current"><a href="CodeTourNotes.html">CodeTourNotes</a></li>
</ul>

</div>
<div class="sidepanel">
<h1>User</h1>
<ul id="username"><li><a href="CodeTourNotes%3Faction=login.html" id="login" rel="nofollow">Login</a></li></ul>
</div>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="CodeTourNotes.html#Other_References">Other References</a><ol><li>
<a href="CodeTourNotes.html#vcheckout_Dissection">vcheckout Dissection</a></li><li>
<a href="CodeTourNotes.html#Auto-generated_Code_Cross-reference">Auto-generated Code Cross-reference</a></li></ol></li><li>
<a href="CodeTourNotes.html#Repository">Repository</a><ol><li>
<a href="CodeTourNotes.html#Base_Chains">Base Chains</a></li></ol></li><li>
<a href="CodeTourNotes.html#Cache_Server">Cache Server</a><ol><li>
<a href="CodeTourNotes.html#Background">Background</a></li><li>
<a href="CodeTourNotes.html#common">common</a></li><li>
<a href="CodeTourNotes.html#client">client</a></li><li>
<a href="CodeTourNotes.html#server">server</a><ol><li>
<a href="CodeTourNotes.html#PKFile_re-write_process">PKFile re-write process</a></li><li>
<a href="CodeTourNotes.html#Cache_Logs">Cache Logs</a></li></ol></li></ol></li><li>
<a href="CodeTourNotes.html#RunToolServer">RunToolServer</a><ol><li>
<a href="CodeTourNotes.html#Client_Library">Client Library</a></li><li>
<a href="CodeTourNotes.html#Server">Server</a></li><li>
<a href="CodeTourNotes.html#tool_launcher">tool_launcher</a></li><li>
<a href="CodeTourNotes.html#RunToolProbe">RunToolProbe</a></li></ol></li></ol></div> <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867">
<h1 id="Other_References">Other References</h1>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h2 id="vcheckout_Dissection">vcheckout Dissection</h2>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867"><a class="http" href="../vesta/doc/api-ref/vcheckout-dissection.html">A description of the implmentation of vcheckout circa October 2004</a>. <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line867">
<h2 id="Auto-generated_Code_Cross-reference">Auto-generated Code Cross-reference</h2>
<span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line862">Thanks to <a href="../KlausElmquist.html">KlausElmquist</a> we now have <a class="http" href="http://pub.vestasys.org/doxygen/">a cross-reference of the code</a> (generated with <a class="http" href="http://www.stack.nl/~dimitri/doxygen/">Doxygen</a>). <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line867">
<h1 id="Repository">Repository</h1>
<span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line867">
<h2 id="Base_Chains">Base Chains</h2>
<span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line867"><span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><img src="CodeTourNotes%3Faction=AttachFile&amp;do=get&amp;target=autogenerated-d649742ff07969647639616b7aeb87a0e9158e49.png" /><span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line867">
<h1 id="Cache_Server">Cache Server</h1>
<span class="anchor" id="line-50"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache//50">/vesta/vestasys.org/vesta/cache/50</a> <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line867">
<h2 id="Background">Background</h2>
<span class="anchor" id="line-53"></span><ul><li><p class="line891"><strong>Concepts </strong> <span class="anchor" id="line-54"></span><ul><li><p class="line891"><span class="u"><em>Cache Index (CI):</em></span> It’s a 32-bit number which uniquely identifies every cache entry. First cache index that gets allocated when CS starts is 0. Indexes that are deleted during weeding reallocated later starting with the lowest available one.  <span class="anchor" id="line-55"></span></li><li><p class="line891"><span class="u"><em>PKFile:</em></span> The on-disk representation of all cache entries for one Primary Key (PK). PK is a 128-bit number. <span class="anchor" id="line-56"></span></li><li><p class="line891"><span class="u"><em>MultiPKFile:</em></span> To avoid having 2^128 files in cache, CS groups PKfiles into MultiPKFiles.      Each MultiPKFile contains PKFiles with the same first 16 bits in their PK.  <span class="anchor" id="line-57"></span></li><li><p class="line891"><span class="u"><em>Epoch:</em></span> It's a 32-bit number. It’s like a version of PKFile. It is used for logging/recovery book-keeping. <span class="anchor" id="line-58"></span></li><li><p class="line891"><span class="u"><em>GraphLog:</em></span> Record written by CS and is used primary by the Weeder. It’s the dependency graph of all cache entries and derived files, plus their relationship to a specific builds. Each cache entry with its CI, child CIs and referenced derived files is recorded in GraphLog. Each build performed (even partial and failing builds) has records for the cache entries used by that build in the GraphLog. GraphLog root is a mapping from a specific build (specifically a model shortid and immutable directory fingerprint) to one or more CIs. <span class="anchor" id="line-59"></span></li><li><p class="line891"><span class="u"><em>Free Variable:</em></span>  <span class="anchor" id="line-60"></span><ul><li><p class="line862">Example: In expression <tt>x&nbsp;+&nbsp;1;</tt> <tt>x</tt> is a free variable and dependency on it will be N/x = FP(int(x)). <span class="anchor" id="line-61"></span></li></ul></li><li><p class="line891"><span class="u"><em>Definition context:</em></span>  <span class="anchor" id="line-62"></span><ul><li><p class="line862">Example: <tt>x&nbsp;=&nbsp;2;&nbsp;x&nbsp;+&nbsp;1;</tt> Here <tt>x</tt> is not a free variable, since it has a determined value, so no dependency will be recorded, <tt>x&nbsp;=&nbsp;2</tt> is a definition context. <span class="anchor" id="line-63"></span></li></ul></li><li><p class="line891"><span class="u"><em>Lease:</em></span> Since Weeder is allowed to work in parallel with ongoing evaluation Cache Server should make sure that currently used cache entries don't get deleted. Cache Server contains a set of currently used CIs – Leased CIs. Whenever evaluator gets Hit on cache entry or just added an entry to the Cache, that CI is added to the set of leased CIs. There is a timeout for leased CIs. <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span></li></ul></li><li class="gap"><p class="line891"><strong>Related Code</strong> <span class="anchor" id="line-66"></span><ul><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/config">/vesta/vestasys.org/vesta/config</a> – access to vesta.cfg. <span class="anchor" id="line-67"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/srpc">/vesta/vestasys.org/vesta/srpc</a> – Simple Remote Procedure Call. <span class="anchor" id="line-68"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/log">/vesta/vestasys.org/vesta/log</a> – atomic logging and recovery (writes .log and .ckp files). <span class="anchor" id="line-69"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/fp">/vesta/vestasys.org/vesta/fp</a> – fingerprinting. Fingerprint is a deterministic hash function which was designed to have a high degree of randomness. <span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span></li></ul></li><li class="gap"><p class="line891"><strong>Useful links</strong> <span class="anchor" id="line-72"></span><ul><li><p class="line891"><a href="../HowCachingWorks.html">HowCachingWorks</a> <span class="anchor" id="line-73"></span></li><li><p class="line862">V!<a class="nonexistent" href="../CacheImpl.html">CacheImpl</a>(7) man page <span class="anchor" id="line-74"></span></li><li><p class="line862">V!<a class="nonexistent" href="../CacheToDo.html">CacheToDo</a>(7) man page - probably out of date. <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span></li></ul></li><li class="gap"><p class="line891"><strong>General</strong> <span class="anchor" id="line-77"></span><ul><li><p class="line862">sizeof_assert function was added when vesta was ported to different machines (see <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/basics/33/src/SizeAssert.H&amp;hilight=1">SizeAssert.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/basics/33/src/SizeAssert.C&amp;hilight=1">SizeAssert.C</a>) <span class="anchor" id="line-78"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/generics/15/src/Generics.H&amp;hilight=1#L42">AtomSeq</a> – Sequence of Atom objects: <span class="anchor" id="line-79"></span><ul><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/generics/15/src/Atom.H&amp;hilight=1">Atom</a> – Text string type, uses global string table to ignore storing the same string more than once. <span class="anchor" id="line-80"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/generics/15/src/Sequence.H&amp;hilight=1">Sequence</a> – expandable array. It is possible to append to or remove from either side of it in O(1). <span class="anchor" id="line-81"></span></li></ul></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/basics/os/24/src/AtomicFile.H&amp;hilight=1">AtomicFile</a> – for request to open a file it creates temporary file with the same name extended by <tt>;&lt;some&nbsp;number&gt;</tt>. All writes are performed to that temporary file. Once that’s done it does sync and replaces original file with the temporary one. <span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span></li></ul></li></ul><p class="line867">
<h2 id="common">common</h2>
<span class="anchor" id="line-85"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/lib.ves&amp;hilight=1">lib.ves</a> <span class="anchor" id="line-86"></span><ul><li><p class="line862">Creates leaf library <strong>libVestaCacheCommon.a</strong> <span class="anchor" id="line-87"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheArgs.H&amp;hilight=1">CacheArgs.H</a>  <span class="anchor" id="line-88"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheArgs.C&amp;hilight=1">CacheArgs.C</a> <span class="anchor" id="line-89"></span><ul><li>Used by Cache Server for command line parsing.  <span class="anchor" id="line-90"></span></li><li><p class="line862">Defines <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheArgs.C&amp;hilight=1#L27">CacheArgs::StartsWith</a> function. <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheConfig.H&amp;hilight=1">CacheConfig.H</a> <span class="anchor" id="line-93"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheConfig.C&amp;hilight=1">CacheConfig.C</a> <span class="anchor" id="line-94"></span><ul><li>Holds cache configuration settings and initializes it. <span class="anchor" id="line-95"></span></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Cache configuration setting should be initialized in particular order. <span class="anchor" id="line-96"></span><ul><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheConfig.H&amp;hilight=1#L31">CacheConfig.H:31-48</a> variables to contain values read from vesta.cfg file <span class="anchor" id="line-97"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheConfig.H&amp;hilight=1#L54">CacheConfig.H:54-67</a> variables to contain computed configuration values. <span class="anchor" id="line-98"></span></li></ul></li><li><p class="line862">Code for initializing configuration variables uses ReadConfig. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/ReadConfig.H&amp;hilight=1">ReadConfig.H</a> <span class="anchor" id="line-101"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/ReadConfig.C&amp;hilight=1">ReadConfig.C</a> <span class="anchor" id="line-102"></span><ul><li>Local wrappers around Vesta config library. <span class="anchor" id="line-103"></span></li><li><p class="line862">All functions have empty throw() statements, so they should not fail, instead in a case of VestaConfig::failure they call <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/ReadConfig.C&amp;hilight=1#L31">DieWithError</a> function which prints out error message and exits. <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheIndex.H&amp;hilight=1">CacheIndex.H</a> <span class="anchor" id="line-106"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheIndex.C&amp;hilight=1">CacheIndex.C</a> <span class="anchor" id="line-107"></span><ul><li>Class Indices contains array of CIs and also knows how to send/receive it over the network. <span class="anchor" id="line-108"></span></li><li><p class="line862">Class IndicesApp – list that can be appended to.  <span class="anchor" id="line-109"></span></li><li><p class="line891"><strong>Note</strong> the similarity to Derived.[HC] <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheIntf.H&amp;hilight=1">CacheIntf.H</a> <span class="anchor" id="line-112"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheIntf.C&amp;hilight=1">CacheIntf.C</a> <span class="anchor" id="line-113"></span><ul><li>Defines enums used by cache clients, functions to convert those to human-readable strings. <span class="anchor" id="line-114"></span></li><li><p class="line891">LookupOutcome used internally to identify outcome of lookup (newHits – not written, warmHits – recently written) <span class="anchor" id="line-115"></span></li><li><p class="line891">DebugLevel – cdebug command line option. Defines what client of CS prints out when sending to/receiving from CS. <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheState.H&amp;hilight=1">CacheState.H</a> <span class="anchor" id="line-118"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheState.C&amp;hilight=1">CacheState.C</a> <span class="anchor" id="line-119"></span><ul><li><p class="line862">Data structures for current state of CS. Used by V!<a class="nonexistent" href="../CacheMonitor.html">CacheMonitor</a>. <span class="anchor" id="line-120"></span></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> MethodCnts, EntryState probably need to be defined as 64-bit. <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Debug.H&amp;hilight=1">Debug.H</a> <span class="anchor" id="line-123"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Debug.C&amp;hilight=1">Debug.C</a> <span class="anchor" id="line-124"></span><ul><li>Debug output utility functions. <span class="anchor" id="line-125"></span></li><li>Lock(), Unlock() for output mutex.  <span class="anchor" id="line-126"></span></li><li>Timestamp() returns current time. <span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Derived.H&amp;hilight=1">Derived.H</a> <span class="anchor" id="line-129"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Derived.C&amp;hilight=1">Derived.C</a> <span class="anchor" id="line-130"></span><ul><li><p class="line862">Types for derived files and lists of derived files. Similar to CacheIndex, only Index is defined as ShortId.  <span class="anchor" id="line-131"></span></li><li>Skip() takes filestream with pos to beginning, reads length() of it without reading the contents and repositions. <span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/ImmutableVal.H&amp;hilight=1">ImmutableVal.H</a> <span class="anchor" id="line-134"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/ImmutableVal.C&amp;hilight=1">ImmutableVal.C</a> <span class="anchor" id="line-135"></span><ul><li>This class is used for copying a value out of one file and into another. Used by CS when re-writing the on-disk storage of cache entries (PKFiles). <span class="anchor" id="line-136"></span></li><li>Holds position in stream, where it starts at and the length of it. The only function here is Copy(), which takes input stream, seeks to start position and copies length. <span class="anchor" id="line-137"></span></li><li><p class="line862">Usage example: <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CacheIndex.C&amp;hilight=1#L88">ReadImmutable()</a> <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Model.H&amp;hilight=1">Model.H</a> <span class="anchor" id="line-140"></span><ul><li><p class="line862">typedef for ShortId.  <span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/PKEpoch.H&amp;hilight=1">PKEpoch.H</a> <span class="anchor" id="line-143"></span><ul><li>Type for epoch of a PKFile. typedef for int. <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/PKPrefix.H&amp;hilight=1">PKPrefix.H</a> <span class="anchor" id="line-146"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/PKPrefix.C&amp;hilight=1">PKPrefix.C</a> (<strong>Note:</strong> don’t confuse with PrefixTbl) <span class="anchor" id="line-147"></span><ul><li>Takes PK and turns it into 16-bit prefix. Also defines type for a list of prefixes. <span class="anchor" id="line-148"></span></li><li>Granularity() = 16 bits. <span class="anchor" id="line-149"></span></li><li>Pathname() – takes PKPrefix and turns it into filename for MultiPKFile. <span class="anchor" id="line-150"></span></li><li><p class="line862">Hash() – defined because PKPrefix is used as Key to generics SharedTable. <span class="anchor" id="line-151"></span></li><li>PKPrefix::List is used during weeding for deletion PKfiles. <span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TextIO.H&amp;hilight=1">TextIO.H</a> <span class="anchor" id="line-154"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TextIO.C&amp;hilight=1">TextIO.C</a> <span class="anchor" id="line-155"></span><ul><li>Reading/writing text strings. Text is a null terminated string. <span class="anchor" id="line-156"></span></li><li>PKfile has source function - SDL source code for that PK. <span class="anchor" id="line-157"></span></li><li><p class="line891"><strong>Note</strong>: length limitation (example: Write() – run_tool call with command line bigger then 16 bits). <span class="anchor" id="line-158"></span><span class="anchor" id="line-159"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Timer.H&amp;hilight=1">Timer.H</a> <span class="anchor" id="line-160"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/Timer.C&amp;hilight=1">Timer.C</a> <span class="anchor" id="line-161"></span><ul><li>Utility class for counting time going by.  <span class="anchor" id="line-162"></span></li><li>Was used for recording some statistic. Example: how long it takes to do lookup calls. <span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/LookupStats.H&amp;hilight=1">LookupStats.H</a> <span class="anchor" id="line-165"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/LookupStats.C&amp;hilight=1">LookupStats.C</a> <span class="anchor" id="line-166"></span><ul><li>Class for cache lookup timing statistic. Currently unused. <span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/BitVector.H&amp;hilight=1">BitVector.H</a> <span class="anchor" id="line-169"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/BitVector.C&amp;hilight=1">BitVector.C</a> <span class="anchor" id="line-170"></span><ul><li>Class for representing sets of integers clustered close to 0. Big array of bytes. <span class="anchor" id="line-171"></span></li><li><p class="line891">NextAvail() – index of least significant not allocated bit. <span class="anchor" id="line-172"></span></li><li>Cardinality() – total number of bits which are set in that vector. <span class="anchor" id="line-173"></span></li><li>Size() – everything higher then that guarantied to be unset. <span class="anchor" id="line-174"></span></li><li>MSB() – returns -1 if there are no bits set. <span class="anchor" id="line-175"></span></li><li>numWords() – total number of allocated Words. <span class="anchor" id="line-176"></span></li><li><p class="line891">PrintAll() – Weeder output: init CIs – current CIs that are allocated when Weeder starts. <span class="anchor" id="line-177"></span></li><li><p class="line862">operator&lt;= (bv1 set  = bv2 set,  also bv2 may have bits set which are not set in bv1) <span class="anchor" id="line-178"></span></li><li><p class="line862">operator- mathematical set difference (bv1 &amp; !bv2) <span class="anchor" id="line-179"></span></li><li><p class="line862">Cache contains BitVector of CIs. It is good to manipulate it (bit algebra). PKFiles also use BitVector to know which dependencies are common and which are uncommon. <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/PrefixTbl.H&amp;hilight=1">PrefixTbl.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/PrefixTbl.C&amp;hilight=1">PrefixTbl.C</a> <span class="anchor" id="line-182"></span><ul><li>Prefix encoding representation of sets of paths with common prefixes. Used to store free variables.    <span class="anchor" id="line-183"></span></li><li>Used by CompactFV.  <span class="anchor" id="line-184"></span></li><li><p class="line862">Storage optimization for storing and sending over the network sets of common and uncommon dependencies. Point of PrefixTbl is to compress the data. <span class="anchor" id="line-185"></span></li><li>Contains 2 arrays: index array and arc array. <span class="anchor" id="line-186"></span></li><li>Putting stuff into the table is more complicated then reading it out. It takes additional space to compute, but once you’re done you can throw it away. <span class="anchor" id="line-187"></span></li><li><p class="line862">Defined as TextIntTbl. <span class="anchor" id="line-188"></span></li><li>Example: <span class="anchor" id="line-189"></span><ul><li><p class="line862">B/x/y -&gt; 0 (index in prefix table)  <span class="anchor" id="line-190"></span><ul><li style="list-style-type:none"><div><table><tbody><tr>  <td><p class="line862"> i </td>
  <td><p class="line862"> Arc </td>
  <td><p class="line862"> Index </td>
</tr>
<tr>  <td><span class="anchor" id="line-191"></span><p class="line862"> 0 </td>
  <td><p class="line862"> y </td>
  <td><p class="line862"> 1 </td>
</tr>
<tr>  <td><span class="anchor" id="line-192"></span><p class="line862"> 1 </td>
  <td><p class="line862"> x </td>
  <td><p class="line862"> 2 </td>
</tr>
<tr>  <td><span class="anchor" id="line-193"></span><p class="line862"> 2 </td>
  <td><p class="line862"> B </td>
  <td><p class="line862"> &lt;END&gt; </td>
</tr>
</tbody></table></div></li></ul></li><li><p class="line862">B/x/z -&gt; 3 <span class="anchor" id="line-195"></span><ul><li style="list-style-type:none"><div><table><tbody><tr>  <td><p class="line862"> i </td>
  <td><p class="line862"> Arc </td>
  <td><p class="line862"> Index </td>
</tr>
<tr>  <td><span class="anchor" id="line-196"></span><p class="line862"> 0 </td>
  <td><p class="line862"> y </td>
  <td><p class="line862"> 1 </td>
</tr>
<tr>  <td><span class="anchor" id="line-197"></span><p class="line862"> 1 </td>
  <td><p class="line862"> x </td>
  <td><p class="line862"> 2 </td>
</tr>
<tr>  <td><span class="anchor" id="line-198"></span><p class="line862"> 2 </td>
  <td><p class="line862"> B </td>
  <td><p class="line862"> &lt;END&gt; </td>
</tr>
<tr>  <td><span class="anchor" id="line-199"></span><p class="line862"> 3 </td>
  <td><p class="line862"> z </td>
  <td><p class="line862"> 1 </td>
</tr>
</tbody></table></div></li></ul></li><li><p class="line862">B/Q -&gt; 4 <span class="anchor" id="line-201"></span></li><li><p class="line862">B/R -&gt; 5 <span class="anchor" id="line-202"></span><ul><li style="list-style-type:none"><div><table><tbody><tr>  <td><p class="line862"> i </td>
  <td><p class="line862"> Arc </td>
  <td><p class="line862"> Index </td>
</tr>
<tr>  <td><span class="anchor" id="line-203"></span><p class="line862"> 0 </td>
  <td><p class="line862"> y </td>
  <td><p class="line862"> 1 </td>
</tr>
<tr>  <td><span class="anchor" id="line-204"></span><p class="line862"> 1 </td>
  <td><p class="line862"> x </td>
  <td><p class="line862"> 2 </td>
</tr>
<tr>  <td><span class="anchor" id="line-205"></span><p class="line862"> 2 </td>
  <td><p class="line862"> B </td>
  <td><p class="line862"> &lt;END&gt; </td>
</tr>
<tr>  <td><span class="anchor" id="line-206"></span><p class="line862"> 3 </td>
  <td><p class="line862"> z </td>
  <td><p class="line862"> 1 </td>
</tr>
<tr>  <td><span class="anchor" id="line-207"></span><p class="line862"> 4 </td>
  <td><p class="line862"> Q </td>
  <td><p class="line862"> 2 </td>
</tr>
<tr>  <td><span class="anchor" id="line-208"></span><p class="line862"> 5 </td>
  <td><p class="line862"> R </td>
  <td><p class="line862"> 2 </td>
</tr>
</tbody></table></div></li></ul></li></ul></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Maximal number of entries in PrefixTbl is 2^16. If we are going to change that we will need to also change network protocol and make cache to understand both the previous version and the new one. <span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CompactFV.H&amp;hilight=1">CompactFV.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/CompactFV.C&amp;hilight=1">CompactFV.C</a> <span class="anchor" id="line-212"></span><ul><li><p class="line862">A compact representation of sets of free variables. Built on top of the PrefixTbl class. Used for storing FreeVars and sending them over the network. <span class="anchor" id="line-213"></span></li><li>Some types of dependency: <span class="anchor" id="line-214"></span><ul><li>N – normal (entire value) <span class="anchor" id="line-215"></span></li><li>! – existence (!/b/n if n exists in b) <span class="anchor" id="line-216"></span></li></ul></li><li><p class="line862">CompactFV = PrefixTbl + 2 arrays:  <span class="anchor" id="line-217"></span><ul><li>Idx: indexes to prefix table <span class="anchor" id="line-218"></span></li><li>Types: array for characters representing dependency types. <span class="anchor" id="line-219"></span></li><li>In CompactFV Cache has a little understanding of dependency structure, so for a given i <span class="anchor" id="line-220"></span><ul><li>types[i] gives type of that dependency <span class="anchor" id="line-221"></span></li><li><p class="line862">idx[i] gives its index in the PrefixTbl <span class="anchor" id="line-222"></span></li></ul></li></ul></li><li>CompactFV::List constructor - takes FV::List and for each name in that list  <span class="anchor" id="line-223"></span><ul><li>extracts dependency type and writes it to the types[i]. <span class="anchor" id="line-224"></span></li><li><p class="line862">pull name and put it into PrefixTbl, remembering index to the table in idx[i]. <span class="anchor" id="line-225"></span></li></ul></li><li><p class="line862">ToFVList() – Expanding all this to a full list. Getting full string for index i. Loops over CompactFV entries and for each calls PrefixTbl::GetString, writes it to 3rd character, reserving first two for type. Once full string is created it gets appended to free variables list. <span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/FV.H&amp;hilight=1">FV.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/FV.C&amp;hilight=1">FV.C</a> <span class="anchor" id="line-228"></span><ul><li>Representation of list of free variables. Primarily used internally by the Cache Server. <span class="anchor" id="line-229"></span></li><li>FV::Epoch – incremented every time set of free variables gets changed. <span class="anchor" id="line-230"></span></li><li>FV::T - subclass of Text, defines send/receive functions. <span class="anchor" id="line-231"></span></li><li>FV::List - array of names. Basically it's a list of strings. Those strings do include type characters. <span class="anchor" id="line-232"></span></li><li><p class="line862">FV::ListApp - implements capability to append to the list. <span class="anchor" id="line-233"></span><ul><li><p class="line862">Pack() - drop some names from the list based on BitVector it takes as an argument. BitVesctorIter is used to loop over set of bits, starting from <tt>i&nbsp;=&nbsp;0</tt> and <tt>ix</tt> which is next bit out of the BitVectorIter. <tt>ix&nbsp;&gt;=&nbsp;i</tt>. Holes in BitVector are entries to be deleted. If hole in BitVector is reached then <tt>name[ix]</tt> is stored in index <tt>i</tt>.  <span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span></li></ul></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/FV2.H&amp;hilight=1">FV2.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/FV2.C&amp;hilight=1">FV2.C</a> <span class="anchor" id="line-236"></span><ul><li>Representation of list of free variables. Primarily used by the evaluator. <span class="anchor" id="line-237"></span></li><li><p class="line862">Evaluator uses this class only when it wants to add entry. That's why there is no receive function defined. For FreeVariables call it uses CompactFV which has both functions. <span class="anchor" id="line-238"></span></li><li><p class="line862">FV2::T - sequence of strings. Subclass of AtomSeq. <span class="anchor" id="line-239"></span><ul><li><p class="line891">ToText() - glues text strings together with delimiter.  <span class="anchor" id="line-240"></span></li><li><p class="line891">FromStr() - finds delimiters in the string and splits it. <span class="anchor" id="line-241"></span></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Send() - defined in <tt>private</tt>, must be called by FV2::List. Calls ToStr() to create a string. In a case of an arc that contains delimiter it constructs an error message and throws exception. <span class="anchor" id="line-242"></span></li></ul></li><li>FV2::List <span class="anchor" id="line-243"></span><ul><li>Send() - This method is only called to send the free variables when adding entry. Evaluator sends FV2::List and Cache receives it as FV::List.  <span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span></li></ul></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/GraphLog.H&amp;hilight=1">GraphLog.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/GraphLog.C&amp;hilight=1">GraphLog.C</a> <span class="anchor" id="line-246"></span><ul><li>Classes for entries in the cache's graph log. <span class="anchor" id="line-247"></span></li><li>It's in the common library because Cache writes it and Weeder reads it. <span class="anchor" id="line-248"></span></li><li><p class="line891">GraphLog is a sequence of two types of entries - Roots and Nodes. <span class="anchor" id="line-249"></span></li><li><p class="line862">Entry - super class, never gets instantiated. Contains <tt>kind</tt> to differentiate between Roots and Nodes. <span class="anchor" id="line-250"></span><ul><li><p class="line862">Debug() - used by PrintGraphLog <span class="anchor" id="line-251"></span></li><li><p class="line891">DebugFull() - used by PrintGraphLog -v <span class="anchor" id="line-252"></span></li></ul></li><li><p class="line862">Node - represents addition of new Cache Entry (CE). Contains CE index, PK, model (ShortId of SDL code where this function is defined), kids (array of CEs representing functions called by this function), refs (ShortIds of all files which are in the result of this function). <span class="anchor" id="line-253"></span><ul><li><p class="line862">refs make GraphLog go big. For example if SDL function returns 1000 files in a binding then refs will be 1000 * sizeof(ShortId).  <span class="anchor" id="line-254"></span></li></ul></li><li><p class="line862">Root - Contains FP for pkgVersion in which that top model exists, model (ShortId), timestamp (when root was created), cis, done (purely for weeder to use in order to figure out what to keep). <span class="anchor" id="line-255"></span><ul><li><p class="line862">When Weeder has an instruction to keep specific build it computes FP of the directory where that model exists, then matches it and model's sid with the ones of each GraphLog Root. Once match is found weeder knows what CIs to keep. <span class="anchor" id="line-256"></span></li><li>done = true if build has completed. <span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span></li></ul></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/VestaVal.H&amp;hilight=1">VestaVal.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/VestaVal.C&amp;hilight=1">VestaVal.C</a> <span class="anchor" id="line-259"></span><ul><li>Class representing a cached value, which gets returned to the evaluator in a case of Cache Hit.  <span class="anchor" id="line-260"></span></li><li><p class="line862">Uses Derived::Indices, PrefixTbl <span class="anchor" id="line-261"></span><ul><li>FP - is not manipulated by Cache, but by Evaluator. Next time Evaluator needs that FP it would not compute it again.  <span class="anchor" id="line-262"></span></li><li>bytes - serialized representation of all data structures representing binding, lists, etc. <span class="anchor" id="line-263"></span></li><li>len - number of bytes. <span class="anchor" id="line-264"></span></li></ul></li><li><p class="line891"><strong>Note:</strong> a cache entry includes more then this. <span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/NewVal.H&amp;hilight=1">NewVal.H</a> <span class="anchor" id="line-267"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/NewVal.C&amp;hilight=1">NewVal.C</a> <span class="anchor" id="line-268"></span><ul><li>Debug code that is used by test programs. Generates pseudo-random cache entries. <span class="anchor" id="line-269"></span><span class="anchor" id="line-270"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/tests.ves&amp;hilight=1">tests.ves</a> <span class="anchor" id="line-271"></span><ul><li>Build instructions for the test programs.  <span class="anchor" id="line-272"></span><ul><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestBitVector.C&amp;hilight=1">TestBitVector.C</a> - test for BitVector class. Self-contained program <span class="anchor" id="line-273"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestCompactFV.C&amp;hilight=1">TestCompactFV.C</a> - test for ComapctFV class. <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Requires input file with specific info. <span class="anchor" id="line-274"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestPKPrefix.C&amp;hilight=1">TestPKPrefix.C</a> - test for PKPrefix class. <span class="anchor" id="line-275"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestPrefixTbl.C&amp;hilight=1">TestPrefixTbl.C</a> - test for PrefixTbl class. <span class="anchor" id="line-276"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestTimer.C&amp;hilight=1">TestTimer.C</a> - test for Timer. <span class="anchor" id="line-277"></span></li><li><p class="line891"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/common/TestSRPC.C&amp;hilight=1">TestSRPC.C</a> - test of SRPC library functionality and Debug.[HC] <span class="anchor" id="line-278"></span></li></ul></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> It would be good to convert them all to be self-contained programs. <span class="anchor" id="line-279"></span><span class="anchor" id="line-280"></span></li></ul><p class="line867">
<h2 id="client">client</h2>
<span class="anchor" id="line-281"></span><span class="anchor" id="line-282"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/lib.ves&amp;hilight=1">lib.ves</a> <span class="anchor" id="line-283"></span><ul><li><p class="line862">Creates leaf library <strong>libVestaCacheClient.a</strong> <span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/CacheC.H&amp;hilight=1">CacheC.H</a> <span class="anchor" id="line-286"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/CacheC.C&amp;hilight=1">CacheC.C</a> <span class="anchor" id="line-287"></span><ul><li><p class="line862">Class used for the remote procedure calls the evaluator makes: FreeVariables, Lookup, AddEntry, Checkpoint, RenewLeases <span class="anchor" id="line-288"></span></li><li><p class="line862">Evaluator instantiates instance of CacheC and uses it to contact Cache Server. When it instantiated we pass it DebugLevel which corresponds to the <tt>–cdebug</tt> evaluator command line option. <span class="anchor" id="line-289"></span></li><li><p class="line891">FreeVariables() - First thing evaluator does when it tries to perform cache lookup. <span class="anchor" id="line-290"></span><ul><li><p class="line891"><span class="u">Evaluator</span> computes PK and sends it to the CS.  <span class="anchor" id="line-291"></span><ul><li>For user-defined function PK contains function body, variables <span class="anchor" id="line-292"></span></li><li>For run-tool – command line, arguments, environment variables <span class="anchor" id="line-293"></span></li></ul></li><li><p class="line891"><span class="u">Cache Server</span> gets PK, finds PKFile, finds all dependencies in Cache entries in that PKFile and returns them in <tt>CompactFV::List</tt> format.  <span class="anchor" id="line-294"></span><ul><li><p class="line862">If there are no dependencies <tt>isEmpty</tt> is set to <tt>true</tt>.  <span class="anchor" id="line-295"></span></li><li><p class="line891"><tt>FV::Epoch</tt> is returned along with the list of names and <tt>isEmpty</tt> boolean. It represents &quot;version&quot; of of secondary dependencies for this PK. Each time secondary dependency for this PK is added or removed <tt>Epoch</tt> gets updated. <span class="anchor" id="line-296"></span></li></ul></li></ul></li><li>Lookup() <span class="anchor" id="line-297"></span><ul><li><p class="line891"><span class="u">Evaluator</span>  <span class="anchor" id="line-298"></span><ul><li>gets names from CS returned as result of FV call.  <span class="anchor" id="line-299"></span></li><li><p class="line862">Computes FPs of values in current context and creates a <tt>FP::List</tt> which is sent to CS along with <tt>Epoch</tt> returned by FV call and PK.  <span class="anchor" id="line-300"></span></li></ul></li><li><p class="line891"><span class="u">Cache Server</span> returns LookupRes: <span class="anchor" id="line-301"></span><ul><li><p class="line862">Hit: sets CI and VestaVal (serialized bits) arguments. For other results those variables are not changed.  <span class="anchor" id="line-302"></span></li><li><p class="line862">FVMismatch is returned if <tt>Epoch</tt> passed to the Lookup call is older than the current. (That could happen if dependency was added by another eval thread or removed during weeding between those FV and Lookup calls). In that case Evaluator should again call FV, compute FP and make Lookup call. <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Potentially a problem of no continues progress.  <span class="anchor" id="line-303"></span></li><li><p class="line891">BadLookupArgs is returned if number of FP is not equal to the len of names. <span class="anchor" id="line-304"></span></li></ul></li></ul></li><li><p class="line891">AddEntry() is called when Lookup results in Miss. <span class="anchor" id="line-305"></span><ul><li><p class="line891"><span class="u">Evaluator</span> passes <span class="anchor" id="line-306"></span><ul><li>PK  <span class="anchor" id="line-307"></span></li><li><p class="line862">list of names in 2 arrays: <tt>types</tt> and <tt>FV2::List</tt>. Lengths of those arrays should be equal. Only dependencies that used to get the function result are passed to AddEntry. <span class="anchor" id="line-308"></span></li><li><p class="line891"><tt>FP::List</tt> - fingerprints of dependencies values <span class="anchor" id="line-309"></span></li><li><p class="line891">VestaVal - result of the function. AddEntry is called once the result is alredy computed <span class="anchor" id="line-310"></span></li><li>model - sid where function is defined <span class="anchor" id="line-311"></span></li><li>kids – other functions that the function called. (Those kids should be leased) <span class="anchor" id="line-312"></span></li><li>sourceFunc – text denoting where this function is defined <span class="anchor" id="line-313"></span></li></ul></li><li><p class="line891"><span class="u">Cache Server</span> <span class="anchor" id="line-314"></span><ul><li>Returns CI in a case of success. <span class="anchor" id="line-315"></span></li><li><p class="line891">BadArgsParams  if length of FP list is not equal to names length. <span class="anchor" id="line-316"></span></li><li><p class="line891">NoLease – if one of the kids CIs is not leased (should never happen). <span class="anchor" id="line-317"></span></li></ul></li></ul></li><li><p class="line891">RenewLeases()  <span class="anchor" id="line-318"></span><ul><li><p class="line891"><span class="u">Evaluator</span> passes all CI it currently uses. There is Evaluator thread that wakes up once in a while and calls RenewLeases. <span class="anchor" id="line-319"></span></li><li><p class="line891"><span class="u">Cache Server</span> should not return <tt>false</tt> in normal process. <span class="anchor" id="line-320"></span></li><li><p class="line862">Example: Added entries for G(): CI = 5, H(): CI = 7; Entry for f() is not added yet (because there might be for example a runtool that runs long time). RenewLeases is called and CI = 5 and CI = 7 are sent to the Cache. <span class="anchor" id="line-321"></span></li></ul></li></ul><p class="line867"><span class="anchor" id="line-322"></span><span class="anchor" id="line-323"></span><span class="anchor" id="line-324"></span><span class="anchor" id="line-325"></span><span class="anchor" id="line-326"></span><span class="anchor" id="line-327"></span><span class="anchor" id="line-328"></span><span class="anchor" id="line-329"></span><pre><span class="anchor" id="line-1"></span>    f()
<span class="anchor" id="line-2"></span>    {
<span class="anchor" id="line-3"></span>       G();
<span class="anchor" id="line-4"></span>       H();
<span class="anchor" id="line-5"></span>       ...
<span class="anchor" id="line-6"></span>       return;
<span class="anchor" id="line-7"></span>    }</pre><span class="anchor" id="line-330"></span><ul><li><p class="line862">Checkpoint() creates roots in GraphLog. Arguments: <span class="anchor" id="line-331"></span><ul><li>FP of the package where the top model exists <span class="anchor" id="line-332"></span></li><li>nodel - sid of that top model <span class="anchor" id="line-333"></span></li><li>cis- indices it uses <span class="anchor" id="line-334"></span></li><li>done - boolean which indicates if evaluation ended. <span class="anchor" id="line-335"></span></li></ul></li><li>MultiSRPC *conns - keeps track of open connections, makes it possible to multiple threads to contact the server. <span class="anchor" id="line-336"></span></li><li>FP::Tag server_instance – random sequence of bits that is created when server started. Leases only stored in-memory, so if server restarts we loose leases info and all evaluations that contacted previous cache instance are stopped. <span class="anchor" id="line-337"></span><span class="anchor" id="line-338"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/WeederC.H&amp;hilight=1">WeederC.H</a> <span class="anchor" id="line-339"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/WeederC.C&amp;hilight=1">WeederC.C</a> <span class="anchor" id="line-340"></span><ul><li><p class="line862">Class used for the remote procedure calls the weeder makes: WeederRecovering, StartMark, SetHitFilter, GetLeases, ResumeLeaseExp, EndMark, CommitChkpt <span class="anchor" id="line-341"></span></li><li><p class="line891">WeederRecovering() – returns <tt>true</tt> if there is another weeder in progress. Weeder should abort if that’s the case. <span class="anchor" id="line-342"></span></li><li><p class="line891">StartMark() – causes Cache to start new GraphLog and stop expire leases. Returns BitVector of all CIs that exist at that point of time. Then Weeder decides what it wants to delete.  <span class="anchor" id="line-343"></span></li><li><p class="line891">SetHitFilter() – sets another BitVector of all CIs Weeder wants to delete, so Cache Server will return Miss on those entries. <span class="anchor" id="line-344"></span></li><li><p class="line891">GetLeases() – returns a BitVector with leased indexes, those should not be deleted. <span class="anchor" id="line-345"></span></li><li><p class="line891">ResumeLeases() – telling Cache to start expire leases. <span class="anchor" id="line-346"></span></li><li><p class="line891">EndMark() – passes Cache BitVector of indices to be deleted and !MultiPKFiles where those CIs exist. <span class="anchor" id="line-347"></span></li><li><p class="line891">CommitChkpt() – writes checkpoint file. <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Should be done by Cache. <span class="anchor" id="line-348"></span><span class="anchor" id="line-349"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/ParCacheC.H&amp;hilight=1">ParCacheC.H</a> <span class="anchor" id="line-350"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/ParCacheC.C&amp;hilight=1">ParCacheC.C</a> <span class="anchor" id="line-351"></span><ul><li>Interface intended for partitioning the cache across multiple servers.  Used by CacheC and WeederC, but not really fleshed out. <span class="anchor" id="line-352"></span></li><li><p class="line862">Intention behind ParCache is to make possible to partition the Cache across multiple servers based on PK. But Cache Server has never been proven as a bottleneck, as opposite to repository. Cache only stores index of meta info. It has a lot of complexity, but it does not use as much CPU resources. So all efforts were put optimizing repository. <span class="anchor" id="line-353"></span><span class="anchor" id="line-354"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/DebugC.H&amp;hilight=1">DebugC.H</a> <span class="anchor" id="line-355"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/DebugC.C&amp;hilight=1">DebugC.C</a> <span class="anchor" id="line-356"></span><ul><li>Interface used by utility/test client programs. <span class="anchor" id="line-357"></span></li><li><p class="line891"><strong>Note:</strong> not currently in the client library, <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> but it probably should be. <span class="anchor" id="line-358"></span></li><li><p class="line862">Uses CacheState. <span class="anchor" id="line-359"></span></li><li><p class="line891">FlushAll() - forces new cache entries to be written out to MultiPKFiles. <span class="anchor" id="line-360"></span><span class="anchor" id="line-361"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/tests.ves&amp;hilight=1">tests.ves</a> <span class="anchor" id="line-362"></span><ul><li><p class="line862">Builds the test programs <tt>TestCache</tt> and <tt>TestCacheRandom</tt> <span class="anchor" id="line-363"></span></li><li><p class="line891"><img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Both need improvement. <span class="anchor" id="line-364"></span><span class="anchor" id="line-365"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/TestCache.C&amp;hilight=1">TestCache.C</a> <span class="anchor" id="line-366"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/TestCache.1.mtex">TestCache.1.mtex</a> <span class="anchor" id="line-367"></span><ul><li>Program for focused tests of the cache server. <span class="anchor" id="line-368"></span></li><li>Takes an input file that specifies a sequence of operations to perform.  (See the tests sub-directory for test input files.) <span class="anchor" id="line-369"></span></li><li><p class="line891"><strong>Note:</strong> only works against an empty cache. <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> It would be nice to extend it to work against a non-empty cache. <span class="anchor" id="line-370"></span></li><li><p class="line891"><a class="http" href="http://vestasys.org/doc/man/html/TestCache.1.html">TestCache(1) man page</a> <span class="anchor" id="line-371"></span><span class="anchor" id="line-372"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/TestCacheRandom.C&amp;hilight=1">TestCacheRandom.C</a> <span class="anchor" id="line-373"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/TestCacheRandom.1.mtex">TestCacheRandom.1.mtex</a> <span class="anchor" id="line-374"></span><ul><li>Program for performing pseudo-random cache lookups and entry additions. <span class="anchor" id="line-375"></span></li><li>Can produce a much higher rate of transactions that normal, but devolves into lookup-only pretty quickly. <span class="anchor" id="line-376"></span></li><li><p class="line891"><a class="http" href="http://vestasys.org/doc/man/html/TestCacheRandom.1.html">TestCacheRandom(1) man page</a> <span class="anchor" id="line-377"></span><span class="anchor" id="line-378"></span><span class="anchor" id="line-379"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/Histogram.H&amp;hilight=1">Histogram.H</a> <span class="anchor" id="line-380"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/Histogram.C&amp;hilight=1">Histogram.C</a> <span class="anchor" id="line-381"></span><ul><li><p class="line862">Code compiled into TestCacheRandom but apparently unused? <span class="anchor" id="line-382"></span><span class="anchor" id="line-383"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/progs.ves&amp;hilight=1">progs.ves</a> <span class="anchor" id="line-384"></span><ul><li><p class="line862">Builds the utility client programs <tt>ChkptCache</tt>, <tt>FlushCache</tt>, <tt>VCacheMonitor</tt> <span class="anchor" id="line-385"></span><span class="anchor" id="line-386"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/ChkptCache.C&amp;hilight=1">ChkptCache.C</a> <span class="anchor" id="line-387"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/ChkptCache.1.mtex">ChkptCache.1.mtex</a> <span class="anchor" id="line-388"></span><ul><li>Calls the cache Checkpoint method, forcing a flush of all logs and adding a fake graph log root <span class="anchor" id="line-389"></span></li><li><p class="line891"><a class="http" href="http://vestasys.org/doc/man/html/ChkptCache.1.html">ChkptCache(1) man page</a> <span class="anchor" id="line-390"></span><span class="anchor" id="line-391"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/FlushCache.C&amp;hilight=1">FlushCache.C</a> <span class="anchor" id="line-392"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/FlushCache.1.mtex">FlushCache.1.mtex</a> <span class="anchor" id="line-393"></span><ul><li><p class="line862">Calls the cache FlushAll method, forcing all new cache entries to be written out to MultiPKFiles. <span class="anchor" id="line-394"></span></li><li><p class="line891"><a class="http" href="http://vestasys.org/doc/man/html/FlushCache.1.html">FlushCache(1) man page</a> <span class="anchor" id="line-395"></span><span class="anchor" id="line-396"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/VCacheMonitor.C&amp;hilight=1">VCacheMonitor.C</a> <span class="anchor" id="line-397"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/client/VCacheMonitor.1.mtex">VCacheMonitor.1.mtex</a> <span class="anchor" id="line-398"></span><ul><li>The cache server monitor program <span class="anchor" id="line-399"></span></li><li><p class="line891"><a class="http" href="http://vestasys.org/doc/man/html/VCacheMonitor.1.html">VCacheMonitor(1) man page</a> <span class="anchor" id="line-400"></span><span class="anchor" id="line-401"></span></li></ul><p class="line867">
<h2 id="server">server</h2>
<span class="anchor" id="line-402"></span><span class="anchor" id="line-403"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/lib.ves&amp;hilight=1">lib.ves</a> <span class="anchor" id="line-404"></span><ul><li><p class="line862">Creates leaf library <strong>libVestaCacheServer.a</strong> <span class="anchor" id="line-405"></span><span class="anchor" id="line-406"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/CacheConfigServer.H&amp;hilight=1">CacheConfigServer.H</a> <span class="anchor" id="line-407"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/CacheConfigServer.C&amp;hilight=1">CacheConfigServer.C</a> <span class="anchor" id="line-408"></span><ul><li>configuration settings that are specific for Cache Server <span class="anchor" id="line-409"></span><ul><li><p class="line862">Config_MaxRunning – maximal number of threads that may talk to CS simultaneously <span class="anchor" id="line-410"></span></li><li><p class="line862">Config_MaxBlocked – maximal number of threads that are waiting to talk to CS. <span class="anchor" id="line-411"></span><span class="anchor" id="line-412"></span></li></ul></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/IntIntTblLR.H&amp;hilight=1">IntIntTblLR.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/IntIntTblLR.C&amp;hilight=1">IntIntTblLR.C</a> <span class="anchor" id="line-413"></span><ul><li>Class implementing a mapping from integers to integers. <span class="anchor" id="line-414"></span></li><li>Used in cache entry class to map from the entry's FP list index to the PKFile's free variable list index <span class="anchor" id="line-415"></span><span class="anchor" id="line-416"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/Combine.H&amp;hilight=1">Combine.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/Combine.C&amp;hilight=1">Combine.C</a> <span class="anchor" id="line-417"></span><ul><li><p class="line891"><strong>Combine::XorFPTag</strong>: class for combining multiple fingerprints, specifically the ucommon subset of the FPs for a cache entry to form an <em>uncommon fingerprint</em> <span class="anchor" id="line-418"></span><span class="anchor" id="line-419"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/CacheEntry.H&amp;hilight=1">CacheEntry.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/CacheEntry.C&amp;hilight=1">CacheEntry.C</a> <span class="anchor" id="line-420"></span><ul><li><p class="line891"><strong>CE::T</strong>: Class representing a single cache entry <span class="anchor" id="line-421"></span></li><li><p class="line891"><strong>CE::List</strong>: Class representing a list of cache entries <span class="anchor" id="line-422"></span><ul><li>Implementing as a linked list (in LISP-ish cons-cell style) <span class="anchor" id="line-423"></span></li></ul></li><li><p class="line862">The list of names is not present, those are kept in PKFile level. List of FPs in Cache Entry might be in  completely different order then the list of names in PKFile. IntIntTbl performs mapping between entry's FP list index to the names list index. <span class="anchor" id="line-424"></span></li><li>uncommonNames – set of names which this CE depends on, but not all CEs for given PK. <span class="anchor" id="line-425"></span></li><li>uncommonTag – FPs of uncommon names, combined together. <span class="anchor" id="line-426"></span><span class="anchor" id="line-427"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/SPKFile.H&amp;hilight=1">SPKFile.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/SPKFile.C&amp;hilight=1">SPKFile.C</a> <span class="anchor" id="line-428"></span><ul><li>Class representing a stable (i.e. on-disk) PKFile <span class="anchor" id="line-429"></span></li><li>Base class for VPKFile <span class="anchor" id="line-430"></span></li><li>PKEpoch – incremented every time the file gets rewritten. <span class="anchor" id="line-431"></span></li><li>namesEpoch – incremented every time set of names changes. <span class="anchor" id="line-432"></span></li><li><p class="line862">CPK!<a class="nonexistent" href="../EntryMap.html">EntryMap</a> – table mapping from common FP to the CEs list for that given FP. <span class="anchor" id="line-433"></span><span class="anchor" id="line-434"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/SPKFileRep.H&amp;hilight=1">SPKFileRep.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/SPKFileRep.C&amp;hilight=1">SPKFileRep.C</a> <span class="anchor" id="line-435"></span><ul><li>Helper code for reading/writing the on-disk representation of a PKFile <span class="anchor" id="line-436"></span><span class="anchor" id="line-437"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/VPKFile.H&amp;hilight=1">VPKFile.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/VPKFile.C&amp;hilight=1">VPKFile.C</a> <span class="anchor" id="line-438"></span><ul><li>Class representing a volatile (i.e. in memory) PKFile <span class="anchor" id="line-439"></span></li><li>Derived from SPKFile <span class="anchor" id="line-440"></span></li><li>every VPKFile has a mutex that provide an exclusive access to it. <span class="anchor" id="line-441"></span></li><li><p class="line891">NameMap – when evaluator wants to add an entry it sends list of names and FPs to CS. Some of those names may already exist for that PK. So there is a mapping from name to the index in <tt>allNames</tt> list. <span class="anchor" id="line-442"></span></li><li>newCommon – new entries that were added recently, but are not on disk yet and depend on all common names. Cache updates set of Common Names when it writes them on disk, it does not do it in memory. <span class="anchor" id="line-443"></span></li><li>newUncommon – entries that do not depend on all common names. <span class="anchor" id="line-444"></span></li><li><p class="line862">freePK!<a class="nonexistent" href="../FileEpoch.html">FileEpoch</a> – keeps track how recently this PKFile was used by lookup or some other operation. If in some point it was not touched for some time the VPKFile gets removed from memory. <span class="anchor" id="line-445"></span></li><li>evicted – if it has been decided that the file should be removed from memory, but there is a thread that just accepted pointer to that VPKFile, but did not do any operation on it. <span class="anchor" id="line-446"></span><span class="anchor" id="line-447"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/EmptyPKLog.H&amp;hilight=1">EmptyPKLog.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/EmptyPKLog.C&amp;hilight=1">EmptyPKLog.C</a> <span class="anchor" id="line-448"></span><ul><li>Each time PKfile gets rewritten the epoch is incremented.  <span class="anchor" id="line-449"></span></li><li>CS also remembers epoch of every PKFile that was deleted for a case of its recreation. In some cases thought it may be recreated with epoch 0.  <span class="anchor" id="line-450"></span><span class="anchor" id="line-451"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/PrintGraphLog.C&amp;hilight=1">PrintGraphLog.C</a> <span class="anchor" id="line-452"></span><ul><li><p class="line862">PK is computed by Eval, CI is assigned by CS. The only way to go from CI to PK is to look in GraphLog, only GraphLog contain that information. <img alt="/!\" height="15" src="../moin_static199/vesta/img/alert.png.html" title="/!\" width="15" /> Maybe we should create an utility to go over <a href="../GraphLog.html">GraphLog</a> and find PK for specific CI. <span class="anchor" id="line-453"></span></li><li><p class="line891">VestaLogSeq – GraphLog is a sequence of one <tt>.cpk</tt> file and one or more <tt>.log</tt> files.  <span class="anchor" id="line-454"></span></li><li><p class="line862">graphLogSeq.Next() - returns RecoveryReader which is <tt>.cpk</tt> or <tt>.log</tt> file. <span class="anchor" id="line-455"></span></li><li><p class="line891">ReadGraphLog – gets RecoveryReader, reads it and creates right types of objects by calling GraphLog::Entry::Recover. It also increments Nodes and Roots counters accordingly. <span class="anchor" id="line-456"></span><span class="anchor" id="line-457"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/VPKFileChkPt.H&amp;hilight=1">VPKFileChkPt.H</a> <span class="anchor" id="line-458"></span><ul><li>Data structure used while re-writing on-disk PKFiles.  This allows the in-memory VPKFile to continue to be updated by clients while the file is being re-written. <span class="anchor" id="line-459"></span></li><li>Also used after the on-disk PKFile has been updated to bring VPKFile into sync with the stable PKFile <span class="anchor" id="line-460"></span></li><li><p class="line862">Created with <tt>SPKFile::CheckPoint</tt> and <tt>VPKFile::CheckPoint</tt> <span class="anchor" id="line-461"></span></li><li><p class="line862">Used by <tt>SPKFile::Update</tt> and <tt>VPKFile::Update</tt> <span class="anchor" id="line-462"></span><span class="anchor" id="line-463"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/Intvl.H&amp;hilight=1">Intvl.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/Intvl.C&amp;hilight=1">Intvl.C</a> <span class="anchor" id="line-464"></span><ul><li>Class used for logging the allocation/freeing of CIs <span class="anchor" id="line-465"></span><span class="anchor" id="line-466"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/FlushQueue.H&amp;hilight=1">FlushQueue.H</a> <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/FlushQueue.C&amp;hilight=1">FlushQueue.C</a> <span class="anchor" id="line-467"></span><ul><li>Class used to allow multiple threads to synchronize the operation of flushing an in-memory data structure to a log file on disk <span class="anchor" id="line-468"></span><span class="anchor" id="line-469"></span></li></ul><p class="line867">
<h3 id="PKFile_re-write_process">PKFile re-write process</h3>
<span class="anchor" id="line-470"></span><span class="anchor" id="line-471"></span><ul><li>VPKFileChkPt class <span class="anchor" id="line-472"></span><ul><li><p class="line891"><tt>SPKFile::CheckPoint</tt> and <tt>VPKFile::CheckPoint</tt>: create a VPKFileChkPt <span class="anchor" id="line-473"></span></li></ul></li><li><p class="line891"><tt>SPKFile::Update</tt> <span class="anchor" id="line-474"></span><ul><li><p class="line891"><tt>SPKFile::ScanCommonTable</tt> and <tt>SPKFile::ScanList</tt>: determines: <span class="anchor" id="line-475"></span><ul><li>set of names in new PKFile <span class="anchor" id="line-476"></span></li><li>set of common names in new PKFile <span class="anchor" id="line-477"></span></li><li>how many entries are present in the new PKFile <span class="anchor" id="line-478"></span></li><li>whether any are deleted <span class="anchor" id="line-479"></span></li></ul></li><li><p class="line891"><tt>FV::ListApp::Pack</tt>: used to remove names which are no longer in the PKFile <span class="anchor" id="line-480"></span></li><li><p class="line891"><tt>SPKFile::UpdateCommonTable</tt> and <tt>SPKFile::UpdateList</tt>: <span class="anchor" id="line-481"></span><ul><li>update entries according to changes in set of names, common/uncommon name status <span class="anchor" id="line-482"></span></li><li>places entires into CPF groups (as they may have changed) <span class="anchor" id="line-483"></span></li><li>drops deleted entries <span class="anchor" id="line-484"></span></li></ul></li><li><p class="line891"><tt>SPKFile::ExtractEntries</tt>: gathers all entries from all (old) CFP groups (used by <tt>SPKFile::UpdateCommonTable</tt>) <span class="anchor" id="line-485"></span></li><li><p class="line891"><tt>SPKFile::AddEntries</tt>: places new entries from VPKFileChkPt into CFP groups <span class="anchor" id="line-486"></span></li></ul></li><li><p class="line891"><tt>VPKFile::Update</tt>: after updating the on-disk PKFile, updates the in-memory PKFile <span class="anchor" id="line-487"></span><ul><li><p class="line891"><tt>VPKFile::DeleteCheckpointedEntries</tt>: removes entries from <tt>newCommon</tt> and <tt>newUncommon</tt> that were in the checkpoint used when writing the PKFile <span class="anchor" id="line-488"></span></li><li><p class="line891"><tt>VPKFile::RecordCIsFromTbl</tt>, <tt>VPKFile::RecordCIsFromList</tt>: Gather CIs of entries to be kept in memory <span class="anchor" id="line-489"></span></li><li><p class="line891"><tt>VPKFile::DeleteOldEntries</tt>: removes all entries from <tt>oldEntries</tt>.  (This needs to be done because they need to be re-sorted into their new CFP groups.) <span class="anchor" id="line-490"></span></li><li><p class="line891"><tt>VPKFile::CopyByCIs</tt>: copies cache entries from the <tt>SPKFile</tt>'s <tt>oldEntries</tt> into the <tt>VPKFile</tt>'s <tt>oldEntries</tt> based on the set of CIs of cache entries to be kept in memory previously gathered <span class="anchor" id="line-491"></span></li><li><p class="line891"><tt>VPKFile::MoveCommonToUncommon</tt>, <tt>VPKFile::MoveCommonListToUncommon</tt>: moves any entries left in <tt>newCommon</tt> (just those added since the checkpoint was taken) into <tt>newUncommon</tt>.  (This is neccessary, as we're about to change the common names based on <tt>exCommonNames</tt> and <tt>exUncommonNames</tt>.) <span class="anchor" id="line-492"></span></li><li><p class="line891"><tt>VPKFile::UpdateUncommonList</tt>: update all the entries in <tt>newUncommon</tt> based on <tt>packMask</tt> and <tt>reMap</tt>, and re-distribute them into <tt>newCommon</tt> and <tt>newUncommon</tt> based on the new set of common names. <span class="anchor" id="line-493"></span><ul><li><p class="line891"><tt>VPKFile::CycleDeletedNamesInList</tt>: re-add any FV names used by new entries which were deleted in the stable PKFile <span class="anchor" id="line-494"></span><span class="anchor" id="line-495"></span></li></ul></li></ul></li></ul><p class="line867">
<h3 id="Cache_Logs">Cache Logs</h3>
<span class="anchor" id="line-496"></span><span class="anchor" id="line-497"></span><p class="line874">For recording new entries: <span class="anchor" id="line-498"></span><span class="anchor" id="line-499"></span><ol type="1"><li><p class="line891"><strong>CI log</strong>: logs allocation of <em>cache indecies</em> <span class="anchor" id="line-500"></span><ul><li><p class="line891"><tt>.ckp</tt> file contains the full <tt>usedCIs</tt> <tt>BitVector</tt> <span class="anchor" id="line-501"></span></li><li><p class="line891"><tt>.log</tt> file contains a sequence of <tt>Intvl::T</tt> objects (see <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/cache/50/src/server/Intvl.H&amp;hilight=1">Intvl.H</a>) <span class="anchor" id="line-502"></span></li></ul></li><li><p class="line891"><strong>Graph log</strong>: logs parent/child relationship between newly added cache entries <span class="anchor" id="line-503"></span><ul><li><p class="line891"><tt>.ckp</tt> and <tt>.log</tt> files have the same format: a sequence of <tt>GraphLog::Node</tt> objects <span class="anchor" id="line-504"></span></li></ul></li><li><p class="line891"><strong>Cache log</strong>: logs newly added cache entries not yet written to on-disk PKFiles <span class="anchor" id="line-505"></span><ul><li><p class="line891"><tt>.ckp</tt> and <tt>.log</tt> files have the same format: a sequence of <tt>CacheLog::Entry</tt> objects <span class="anchor" id="line-506"></span><span class="anchor" id="line-507"></span></li></ul></li></ol><p class="line867"><em>The above three logs must always be written in exactly the order shown above!</em>  Because the data is stored in separate logs, we must write them out in this order to avoid inconsistencies if the server restarts.  An inconsistency would be: <span class="anchor" id="line-508"></span><span class="anchor" id="line-509"></span><ul><li>A client getting a hit on a cache entry with no graph log entry (the weeder could delete it or its referenced files) <span class="anchor" id="line-510"></span></li><li>A client getting a hit on a cache entry with an unallocated CI (the same CI could wind up used by another cache entry, and also cause problems during weeding) <span class="anchor" id="line-511"></span></li><li>A graph log entry with an unallocated CI (also causing weeding problems) <span class="anchor" id="line-512"></span><span class="anchor" id="line-513"></span></li></ul><p class="line874">Because of the order there are a couple possibilities of a newly added cache entry not being completely written to disk: <span class="anchor" id="line-514"></span><span class="anchor" id="line-515"></span><ul><li>If a server failure happens immediately, nothing might make it to disk at all (not even the CI allocation) <span class="anchor" id="line-516"></span></li><li>The CI allocation might make be logged, but the graph log entry might not <span class="anchor" id="line-517"></span></li><li>The CI allocation and graph log entry might be logged, but not the cache entry <span class="anchor" id="line-518"></span></li><li>The CI allocation, graph log entry, and cache log entry might make it to disk, but the PKFile may not yet be re-written. <span class="anchor" id="line-519"></span><span class="anchor" id="line-520"></span></li></ul><p class="line874">How is log order flushing enforced? <span class="anchor" id="line-521"></span><span class="anchor" id="line-522"></span><ul><li><p class="line891"><tt>CacheS::FlushCacheLog</tt> calls <tt>CacheS::FlushGraphLog</tt> <span class="anchor" id="line-523"></span></li><li><p class="line891"><tt>CacheS::FlushGraphLog</tt> calls <tt>CacheS::FlushUsedCIs</tt> <span class="anchor" id="line-524"></span><span class="anchor" id="line-525"></span></li></ul><p class="line867">
<h1 id="RunToolServer">RunToolServer</h1>
<span class="anchor" id="line-526"></span><span class="anchor" id="line-527"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37">/vesta/vestasys.org/vesta/run_tool/37</a> <span class="anchor" id="line-528"></span><span class="anchor" id="line-529"></span><p class="line867">
<h2 id="Client_Library">Client Library</h2>
<span class="anchor" id="line-530"></span><span class="anchor" id="line-531"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/lib.ves&amp;hilight=1">lib.ves</a> <span class="anchor" id="line-532"></span><ul><li><p class="line862">Creates leaf library <strong>libVestaRunTool.a</strong> <span class="anchor" id="line-533"></span><span class="anchor" id="line-534"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolClient.H&amp;hilight=1">RunToolClient.H</a> <span class="anchor" id="line-535"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolClient.C&amp;hilight=1">RunToolClient.C</a> <span class="anchor" id="line-536"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolClientPrivate.H&amp;hilight=1">RunToolClientPrivate.H</a> <span class="anchor" id="line-537"></span><span class="anchor" id="line-538"></span><ul><li><p class="line862">Defines client side interface used by the evaluator and RunToolProbe <span class="anchor" id="line-539"></span></li><li><p class="line891"><tt>RunTool::do_it</tt> is the function for invoking a tool <span class="anchor" id="line-540"></span></li><li><p class="line891"><tt>RunTool::get_info</tt> is the function for finding out about a RunToolServer to match against a platform definition and determine how busy/idle it is. <span class="anchor" id="line-541"></span></li><li><p class="line862">The class <tt>Tool_Relay</tt> is used internally for relaying standard ouput/error back to the caller.  It uses a separate TCP connection and a separate thread for each relayed stream. <span class="anchor" id="line-542"></span><span class="anchor" id="line-543"></span></li></ul><p class="line867">
<h2 id="Server">Server</h2>
<span class="anchor" id="line-544"></span><span class="anchor" id="line-545"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/ServerMain.C&amp;hilight=1">ServerMain.C</a> <span class="anchor" id="line-546"></span><span class="anchor" id="line-547"></span><ul><li><p class="line862">Startup code (<tt>main</tt> function) <span class="anchor" id="line-548"></span></li><li><p class="line891"><tt>LimService</tt> bits to receive network calls <span class="anchor" id="line-549"></span><span class="anchor" id="line-550"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolDaemon.H&amp;hilight=1">RunToolDaemon.H</a> <span class="anchor" id="line-551"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolDaemon.C&amp;hilight=1">RunToolDaemon.C</a> <span class="anchor" id="line-552"></span><span class="anchor" id="line-553"></span><ul><li>Main server implementation <span class="anchor" id="line-554"></span></li><li><p class="line891"><tt>children</tt> class records active and pending tools <span class="anchor" id="line-555"></span><ul><li>handles waiting for an available slot <span class="anchor" id="line-556"></span></li><li>handles waiting for tool completion <span class="anchor" id="line-557"></span></li></ul></li><li><p class="line891"><tt>req_data</tt> class represents a single tool call <span class="anchor" id="line-558"></span><ul><li>records arguments <span class="anchor" id="line-559"></span></li><li>has additional member variables for state <span class="anchor" id="line-560"></span><span class="anchor" id="line-561"></span></li></ul></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/Launcher.h&amp;hilight=1">Launcher.h</a> <span class="anchor" id="line-562"></span><span class="anchor" id="line-563"></span><ul><li><p class="line862">Constants used for interacting with the <tt>tool_launcher</tt> program <span class="anchor" id="line-564"></span><span class="anchor" id="line-565"></span></li></ul><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/get_load.h&amp;hilight=1">get_load.h</a> <span class="anchor" id="line-566"></span><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/get_load.c&amp;hilight=1">get_load.c</a> <span class="anchor" id="line-567"></span><span class="anchor" id="line-568"></span><ul><li><p class="line862">Cross-platform code for getting the load average.  Lifted from <tt>xload</tt> and adapted for use in the RunToolServer <span class="anchor" id="line-569"></span><span class="anchor" id="line-570"></span></li></ul><p class="line867">
<h2 id="tool_launcher">tool_launcher</h2>
<span class="anchor" id="line-571"></span><span class="anchor" id="line-572"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/tool_launcher.c&amp;hilight=1">tool_launcher.c</a> <span class="anchor" id="line-573"></span><span class="anchor" id="line-574"></span><ul><li>Small program to perform the chroot system call and exec the tool. <span class="anchor" id="line-575"></span></li><li>chroot requires root priviledges, so the tool_launcher binary must be setuid root <span class="anchor" id="line-576"></span></li><li>Written as a separate program to minimize the amount of code which executes setuid root <span class="anchor" id="line-577"></span><span class="anchor" id="line-578"></span></li></ul><p class="line867">
<h2 id="RunToolProbe">RunToolProbe</h2>
<span class="anchor" id="line-579"></span><span class="anchor" id="line-580"></span><p class="line867"><a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/run_tool/37/src/RunToolProbe.C&amp;hilight=1">RunToolProbe.C</a> <span class="anchor" id="line-581"></span><span class="anchor" id="line-582"></span><ul><li><p class="line862">Small program for calling <tt>RunTool::get_info</tt> and printing the result to standard output. <span class="anchor" id="line-583"></span></li></ul><span class="anchor" id="bottom"></span></div>
<div id="pagebottom"></div>
</div>


<div id="footer">
<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>
</html>

