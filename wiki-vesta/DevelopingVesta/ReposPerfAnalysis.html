<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>DevelopingVesta/ReposPerfAnalysis - Vesta Wiki</title>
<script type="text/javascript" src="moin_static199/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="../moin_static199/vesta/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="../moin_static199/vesta/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="../moin_static199/vesta/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/msie.css">
<![endif]-->


<link rel="alternate" title="Vesta Wiki: DevelopingVesta/ReposPerfAnalysis" href="ReposPerfAnalysis%3Fdiffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=DevelopingVesta%252FReposPerfAnalysis&amp;ddiffs=1.html" type="application/rss+xml">


<link rel="Start" href="FrontPage.html">
<link rel="Alternate" title="Wiki Markup" href="ReposPerfAnalysis%3Faction=raw.html">
<link rel="Alternate" media="print" title="Print View" href="ReposPerfAnalysis%3Faction=print.html">
<link rel="Up" href="DevelopingVesta.html">
<link rel="Search" href="FindPage.html">
<link rel="Index" href="TitleIndex.html">
<link rel="Glossary" href="WordIndex.html">
<link rel="Help" href="HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr">

<div id="header">

<form id="searchform" method="get" action="ReposPerfAnalysis.html">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="FrontPage.html"><img src="wiki/vesta/img/1line.png" alt="Vesta" height=44 width=202></a></div>
<div id="locationline">

<ul id="pagelocation">
<li><a href="DevelopingVesta.html">DevelopingVesta</a></li><li><a href="ReposPerfAnalysis.html">ReposPerfAnalysis</a></li>
</ul>

</div>
</div>

<div id="sidebar">
<div class="sidepanel">
<h1>Wiki</h1>

<ul id="navibar">
<li class="wikilink"><a href="RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a href="FindPage.html">FindPage</a></li><li class="wikilink"><a href="HelpContents.html">HelpContents</a></li><li class="current"><a href="ReposPerfAnalysis.html">ReposPerfAnalysis</a></li>
</ul>

</div>
<div class="sidepanel">
<h1>User</h1>
<ul id="username"><li><a href="ReposPerfAnalysis%3Faction=login.html" id="login" rel="nofollow">Login</a></li></ul>
</div>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="ReposPerfAnalysis.html#Introduction">Introduction</a></li><li>
<a href="ReposPerfAnalysis.html#Building_with_Performance_Debug">Building with Performance Debug</a></li><li>
<a href="ReposPerfAnalysis.html#Recording_Data">Recording Data</a></li><li>
<a href="ReposPerfAnalysis.html#Analyzing_the_Data">Analyzing the Data</a><ol><li>
<a href="ReposPerfAnalysis.html#Reading_the_Report_from_read_timing">Reading the Report from read_timing</a></li><li>
<a href="ReposPerfAnalysis.html#Reading_Graphs_from_read_timing">Reading Graphs from read_timing</a></li><li>
<a href="ReposPerfAnalysis.html#Reading_the_Report_from_read_lock_timing">Reading the Report from read_lock_timing</a></li><li>
<a href="ReposPerfAnalysis.html#Reading_Graphs_from_read_lock_timing">Reading Graphs from read_lock_timing</a></li></ol></li></ol></div> <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h1 id="Introduction">Introduction</h1>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">The repository has some features for analysis of its performance which <span class="anchor" id="line-10"></span>are intended to help a developer identify opportunities for <span class="anchor" id="line-11"></span>optimization.  This page describes these features and how to use them. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line874">Note that this page was written relative to a particular version of <span class="anchor" id="line-14"></span>the repository code: <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><ul><li style="list-style-type:none"><p class="line891"><tt>/vesta/vestasys.org/vesta/repos/85</tt> <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></li></ul><p class="line874">If you haven't yet done so, it's probably best to start by reading the <span class="anchor" id="line-19"></span>&quot;Performance Tuning&quot; section in the repository(8) man page. <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line867">
<h1 id="Building_with_Performance_Debug">Building with Performance Debug</h1>
<span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><p class="line874">Even when not turned on, the performance debug data recording features <span class="anchor" id="line-24"></span>have some small negative impact on performance.  For that reason, the <span class="anchor" id="line-25"></span>performance debugging features are not compiled into the repository by <span class="anchor" id="line-26"></span>default. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line862">To enable them at build time, <tt>./vesta/repos/perf_debug</tt> must be <span class="anchor" id="line-29"></span>the value <tt>TRUE</tt>.  The repository package has several top-level <span class="anchor" id="line-30"></span>models whith names ending in &quot;<tt>_perf.main.ves</tt>&quot; which turn this <span class="anchor" id="line-31"></span>feature on.  Alternatively, you can add this to your top-level model: <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line867"><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><pre><span class="anchor" id="line-1"></span>. ++= [ vesta/repos/perf_debug = TRUE ];</pre><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><p class="line874">This affects the repository build in two ways: <span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><ul><li>It compiles the performance debug data recording features into the repository server itself. <span class="anchor" id="line-40"></span></li><li>It causes three additional programs to be built: <span class="anchor" id="line-41"></span><ul><li><p class="line891"><tt>vperfdebug</tt> is used to enable and disable the data recording <span class="anchor" id="line-42"></span></li><li><p class="line891"><tt>read_timing</tt> is used to analyze fine-grained timing data recorded during the processing of NFS transactions <span class="anchor" id="line-43"></span></li><li><p class="line891"><tt>read_lock_timing</tt> is used to analyze data record about the acquisition and release of two central locks <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span></li></ul></li></ul><p class="line867">
<h1 id="Recording_Data">Recording Data</h1>
<span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line874">Once you're running a repository with the data recording features, <span class="anchor" id="line-48"></span>you'll need to specifically enable them.  This allows you to record <span class="anchor" id="line-49"></span>data only during periods of interesting activity. <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line874">There are two types of data which can be recorded: <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><ul><li>Fine-grained timing of the processing of NFS calls.  This helps to identify where the repository is spending time and why certain transactions are slow. <span class="anchor" id="line-54"></span></li><li><p class="line862">The timing of the acquisition and release of several central locks (<tt>StableLock</tt>, <tt>VolatileRootLock</tt>, and <tt>userGroup_lock</tt>). <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span></li></ul><p class="line874">Normally you want to record both types of data, but it is possible to <span class="anchor" id="line-57"></span>enable and disable the recording of them independently. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line874">To enable both types of data recording: <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line867"><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><pre><span class="anchor" id="line-1-1"></span>% vperfdebug -n -l
<span class="anchor" id="line-2"></span>Enabdled fine-graned NFS call timing
<span class="anchor" id="line-3"></span>Enabdled central lock timing</pre><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><p class="line874">To disable the data recording: <span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><p class="line867"><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><pre><span class="anchor" id="line-1-2"></span>% vperfdebug -N -L
<span class="anchor" id="line-2-1"></span>Disabdled fine-graned NFS call timing
<span class="anchor" id="line-3-1"></span>Disabdled central lock timing</pre><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><p class="line862">(Note that enabling and disabling the performance data recording requires administrator access, so this must be done as <tt>vadmin</tt>, <tt>root</tt>, or <tt>vwizard</tt>.) <span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><p class="line874">The timing data gets stored in files in sub-directories below <span class="anchor" id="line-78"></span><tt>[Repository]metadata_root</tt>.  These directories have names which <span class="anchor" id="line-79"></span>include the date, for example &quot;<tt>timings.2005-12-04</tt>&quot;.  Within <span class="anchor" id="line-80"></span>these directories there are separate files for the two types of data <span class="anchor" id="line-81"></span>recorded.  Each thread gets its own file, and a new file is started <span class="anchor" id="line-82"></span>periodically (by default once per hour, but this can be changed by <span class="anchor" id="line-83"></span>setting <tt>[Repository]timing_file_minutes</tt>).  The filenames include <span class="anchor" id="line-84"></span>the process ID, the thread ID, and the hour and minute of the period <span class="anchor" id="line-85"></span>which the file is for.  Specifically, the filename format is: <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><ul><li><p class="line862">&quot;nfs_calls.pid_<em>123</em>.thread_<em>456</em>.<em>HH</em>_<em>MM</em>&quot; <span class="anchor" id="line-88"></span><ul><li><p class="line891"><tt>read_timing</tt> processes these files <span class="anchor" id="line-89"></span></li></ul></li><li><p class="line862">&quot;rwlocks.pid_<em>123</em>.thread_<em>456</em>.<em>HH</em>_<em>MM</em>&quot; <span class="anchor" id="line-90"></span><ul><li><p class="line891"><tt>read_lock_timing</tt> processes these files <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span></li></ul></li></ul><p class="line867">
<h1 id="Analyzing_the_Data">Analyzing the Data</h1>
<span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line874">The recorded data is in a binary format (mainly to keep the repository <span class="anchor" id="line-95"></span>from spending much time writing it).  To get human-readable <span class="anchor" id="line-96"></span>information out of it, you need to use the <tt>read_timing</tt> and <span class="anchor" id="line-97"></span><tt>read_lock_timing</tt> programs. <span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><p class="line874">They each produce a text file containing a report and one or more <span class="anchor" id="line-100"></span>files of input for <a class="http" href="http://www.gnuplot.info/">gnuplot</a> to generate <span class="anchor" id="line-101"></span>graphs visualizing the data. <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line874">Here's how you run each of these tools: <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><ul><li><p class="line862">read_timing [-o <em>output_prefix</em>] nfs_calls.file1 nfs_calls.file2 ... <span class="anchor" id="line-106"></span><ul><li>By default it creates files in the current directory beginning with &quot;read_timing.out&quot;.  Use the -o option to change this. <span class="anchor" id="line-107"></span></li></ul></li><li><p class="line862">read_lock_timing [-o <em>output_prefix</em>] [-t <em>slow_msecs</em>] rwlocks.file1 rwlocks..file2 ... <span class="anchor" id="line-108"></span><ul><li>By default it creates files in the current directory beginning with &quot;rwlock_timing.out&quot;.  Use the -o option to change this. <span class="anchor" id="line-109"></span></li><li><p class="line862">Further analysis is done on periods where it took more than <em>slow_msecs</em> milliseconds to acquire one of the locks.  This defaults to 1000 (1 second). <span class="anchor" id="line-110"></span><ul><li>You can use the -t option to cause shorter lock acquisition segments to be given scrutiny if not enough slow acquisitions are found. <span class="anchor" id="line-111"></span></li><li>If roo many slow lock acquisitions are found, you can use the -t option to exclude some segments by raising the length considered &quot;slow&quot;. <span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span></li></ul></li></ul></li></ul><p class="line874">After running both tools, you'll want to run gnuplot on each of the <span class="anchor" id="line-114"></span>files ending in &quot;.gnuplot&quot; which was written.  Here's a simple shell <span class="anchor" id="line-115"></span>script which will do that for you: <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><p class="line867"><span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><pre><span class="anchor" id="line-1-3"></span>for f in *.gnuplot; do
<span class="anchor" id="line-2-2"></span>  cat $f | /usr/bin/gnuplot
<span class="anchor" id="line-3-2"></span>done</pre><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><p class="line874">You might find that you want larger images than the default size to <span class="anchor" id="line-126"></span>get more detail in the graphs.  You can increase the size by a factor <span class="anchor" id="line-127"></span>of 1.5 with: <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><p class="line867"><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><pre><span class="anchor" id="line-1-4"></span>for f in *.gnuplot; do
<span class="anchor" id="line-2-3"></span>  ( echo &quot;set size 1.5,1.5&quot; ; cat $f ) | /usr/bin/gnuplot
<span class="anchor" id="line-3-3"></span>done</pre><span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span><p class="line874">(You can use other numbers, but 2 is probably the highest useful value <span class="anchor" id="line-138"></span>unless you have a very large monitor.) <span class="anchor" id="line-139"></span><span class="anchor" id="line-140"></span><p class="line867">
<h2 id="Reading_the_Report_from_read_timing">Reading the Report from read_timing</h2>
<span class="anchor" id="line-141"></span><span class="anchor" id="line-142"></span><p class="line862">The report generated by <tt>read_timing</tt> (named <span class="anchor" id="line-143"></span>&quot;<tt>read_timing.out.report</tt>&quot; unless you used the &quot;<tt>-o</tt>&quot; <span class="anchor" id="line-144"></span>command-line flag) has one section for each NFS procedure.  Each <span class="anchor" id="line-145"></span>section first contains aggregate statistics for all calls of that type <span class="anchor" id="line-146"></span>in the data set: <span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><ul><li><p class="line891"><strong>count</strong>: The total number of calls to this procedure <span class="anchor" id="line-149"></span></li><li><p class="line891"><strong>total time</strong>: The total amount of time spent processing all calls to this procedure <span class="anchor" id="line-150"></span></li><li><p class="line891"><strong>slowest time</strong>: How long the longest call to this procedure took to service <span class="anchor" id="line-151"></span></li><li><p class="line891"><strong>average time</strong>: The average time it took to service a call to this procedure <span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span></li></ul><p class="line874">After this is data which pertains only to the slowest 1% of calls to <span class="anchor" id="line-154"></span>this procedure.  These calls are given more analysis because usually <span class="anchor" id="line-155"></span>they demonstrate the causes of poor performance and represent the best <span class="anchor" id="line-156"></span>opportunities for optimization. <span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><p class="line874">There are four groups of information given about the slowest 1% of <span class="anchor" id="line-159"></span>calls: <span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span><ul><li>The range of time spent in those calls (from the fastest of the slowest 1% to the slowest of the slowest 1%).  This makes it easier to see how far these are from the average across all calls. <span class="anchor" id="line-162"></span></li><li><p class="line862">Three groups of data about where precisely in the code the slowest calls spent their time.  These are given in terms of <em>source intervals</em>.  There are various specific points in the code where records are made during the processing of NFS calls.  (In the code, time points are recorded at each <tt>RECORD_TIME_POINT;</tt> statement.)  This makes it possible for <tt>read_timing</tt> to count the amount of time taken between two locations in the source code. <span class="anchor" id="line-163"></span><ul><li><p class="line891"><strong>slowest intervals in slowest 1%</strong>: For each of the slowest 1% of calls, the source interval which took the longest time is found.  The sections lists those source intervals along with a count of the number of calls in which it was the slowest interval and the percentage of the slowest 1% in which it took the longest time.  The ranges are sorted by how often each was the slowest interval. <span class="anchor" id="line-164"></span></li><li><p class="line891"><strong>total time spent in all intervals in slowest 1%</strong>: This lists each source interval found in the slowest 1% and the aggregate amount of time spent in each.  It also lists what percentage of the total time taken to process all calls in the slowest 1% was spent in this interval.  The ranges are sorted by the total amount of time each took across all of the slowest 1% of calls. <span class="anchor" id="line-165"></span></li><li><p class="line891"><strong>range of time time spent in all intervals in slowest 1%</strong>: For each source interval found in the slowest 1%, this section shows the range of time spent in that interval (from the smallest amount of time spent in it to the longest amount of time spent in it).  The ranges are sorted by the longest amount of time spent in each. <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span></li></ul></li></ul><p class="line862">Finally, some calls (currently <tt>lookup</tt> and <tt>readdir</tt>) list <span class="anchor" id="line-168"></span>specific paths in the repository which required a long time during <span class="anchor" id="line-169"></span>certain source intervals.  After &quot;Slowest StableLock LongId intervals <span class="anchor" id="line-170"></span>recorded&quot;, a source interval is printed followed by a number of <span class="anchor" id="line-171"></span>records of the amount of time taken in that interval and a specific <span class="anchor" id="line-172"></span>path in the repository, printed both as a raw LongId and as a path <span class="anchor" id="line-173"></span>into the repository.  These can be used to identify particular places <span class="anchor" id="line-174"></span>in the repository which may exhibit poor performance (e.g. due to a <span class="anchor" id="line-175"></span>very large directory).  Note that <tt>read_timing</tt> always uses the <span class="anchor" id="line-176"></span>local repository to translate the recorded LongIds back into paths. <span class="anchor" id="line-177"></span>LongIds are not the same across different repositories, so you should <span class="anchor" id="line-178"></span>run it against the same repository where the data was recorded. <span class="anchor" id="line-179"></span><span class="anchor" id="line-180"></span><p class="line874">One important thing to be aware of when looking at the source <span class="anchor" id="line-181"></span>intervals is that some of them represent the acquisition of different <span class="anchor" id="line-182"></span>locks.  To improve those, you need to identify what other thread or <span class="anchor" id="line-183"></span>threads were holding the lock in question and reduce the amount of <span class="anchor" id="line-184"></span>time they hold that lock. <span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span><p class="line867">
<h2 id="Reading_Graphs_from_read_timing">Reading Graphs from read_timing</h2>
<span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><p class="line862">There are three types of graphs produced by <tt>read_timing</tt>: <span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><ul><li><p class="line891"><strong>all_procs_histo</strong> (e.g. <tt>read_timing.out.all_procs_histo.png</tt>): shows a histogram of the time taken to process all NFS requests.  One line is drawn for each NFS procedure and another line is drawn for the sum across all procedures.  The Y axis is the number of calls and is logarithmic.  The X axis is a logarithmic binning of call times.  Specifically, it is the logarithm base 2 of the time in milliseconds rounded up to the next integer.  (So the point at 1 represents the number of calls which took longer than 2<sup>0</sup> millisecond and up to 2<sup>1</sup> milliseconds, the point at 2 represents the number of calls which took longer than 2<sup>1</sup> millisecond and up to 2<sup>2</sup> milliseconds, and so on.) <span class="anchor" id="line-191"></span></li><li><p class="line891"><strong><em>procedure</em>_histo</strong> (e.g. <tt>read_timing.out.create_histo.png</tt>): shows just the histogram for the time to process a single procedure.  The axes are the same as for <strong>all_procs_histo</strong>, but it's a little easier to read. <span class="anchor" id="line-192"></span></li><li><p class="line891"><strong>slow_<em>procedure</em>_histo</strong> (e.g. <tt>read_timing.out.slow_create_histo.png</tt>): shows a histogram of time spent in different source intervals during the processing of the slowest 1% of calls to this procedure.  This gives another way to look at the source interval data for slow calls.  The axes are the same as the other histograms, but one line is drawn for each source interval which has at least some values in more than just the 0 group on the X axis.  The source intervals are sorted such that the first one listed has the highest amount of time in an individual call. <span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span></li></ul><p class="line874">The histogram across all procedures can give you a sense of which <span class="anchor" id="line-195"></span>procedures are taking the most time.  The histogram for a single <span class="anchor" id="line-196"></span>procedure can make it a little easier to see whether there's a gradual <span class="anchor" id="line-197"></span>trend or whether the long calls are statistical outliers.  The source <span class="anchor" id="line-198"></span>interval histogram for slow calls can help with understanding where <span class="anchor" id="line-199"></span>the calls are spending their time. <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span><p class="line867">
<h2 id="Reading_the_Report_from_read_lock_timing">Reading the Report from read_lock_timing</h2>
<span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><p class="line862">The report generated by <tt>read_lock_timing</tt> (named &quot;<tt>rwlock_timing.out.report</tt>&quot; unless you used the &quot;<tt>-o</tt>&quot; command-line flag) lists information about the acquisition and release of central locks.   <tt>StableLock</tt> and <tt>VolatileRootLock</tt> control directory structure in the repository.  <tt>userGroup_lock</tt> controls access to the user and group information used to determine permissions and access.  These are instances of the <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/vesta/repos/85/src/ReadersWritersLock.H#L52">class ReadersWritersLock</a> which allows for multiple simultaneous readers or a single writer.  <tt>StableLock</tt> is used for <tt>/vesta</tt> and <tt>/vesta-work</tt>: anything which reads directory contents must acquire a read lock and anything which changes directory contents must acquire a write lock.  <tt>VolatileRootLock</tt> controls just the volatile root (<tt>/vesta-work/.volatile</tt>), but tends to see a higher rate of locking and unlocking as individual volatile directories are created and deleted quickly as builds run. <span class="anchor" id="line-204"></span><span class="anchor" id="line-205"></span><p class="line862">The data recording for these locks includes the time each thread spends witing to acquire the lock, the time each thread spends holding the lock, and in most cases the reason which is was locked (e.g. &quot;<tt>NFS:lookup</tt>&quot; for servicing an NFS lookup call). <span class="anchor" id="line-206"></span><span class="anchor" id="line-207"></span><p class="line862">For any lock acquisitions that are considered &quot;slow&quot; (i.e. take longer than the tiem specified with the -t option to <tt>read_lock_timing</tt>), additional information is gathered.  All other operations on the same lock from other threads that overlap in time with the lock acquisition are found.  Information about all these operations, including how long the thread took to acquire the lock, how long it held the lock, how long it took to release the lock, where in time it ocurred relative to the other operations, and the reason it was locked.  This makes it possible to see which operations in other threads contributed to the long lock aquisition time.  Sometimes a single thread holding a lock is obviously the cause.  In other cases several smaller operations may have ocurred in the right order to have a combined effect that caused a long acquisition time. <span class="anchor" id="line-208"></span><span class="anchor" id="line-209"></span><p class="line867">
<h2 id="Reading_Graphs_from_read_lock_timing">Reading Graphs from read_lock_timing</h2>
<span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span><p class="line862">For each &quot;slow&quot; lock acquisition, <tt>read_lock_timing</tt>) produces a graph to visually show the sequence of events.  Each vertical line shows one thread performing an operation using the lock during the slow lock acquisition.  Different colors represent periods spent acquiring, holding, and releasing the lock.  The colors for read and write locks are different.  Threads are shown left to right in the same order they are listed top to bottom in the text report. <span class="anchor" id="line-212"></span><span class="anchor" id="bottom"></span></div>
<div id="pagebottom"></div>
</div>


<div id="footer">
<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>
</html>

