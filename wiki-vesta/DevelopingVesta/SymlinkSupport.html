<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>DevelopingVesta/SymlinkSupport - Vesta Wiki</title>
<script type="text/javascript" src="moin_static199/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="../moin_static199/vesta/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="../moin_static199/vesta/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="../moin_static199/vesta/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="../moin_static199/vesta/css/msie.css">
<![endif]-->


<link rel="alternate" title="Vesta Wiki: DevelopingVesta/SymlinkSupport" href="SymlinkSupport%3Fdiffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=DevelopingVesta%252FSymlinkSupport&amp;ddiffs=1.html" type="application/rss+xml">


<link rel="Start" href="FrontPage.html">
<link rel="Alternate" title="Wiki Markup" href="SymlinkSupport%3Faction=raw.html">
<link rel="Alternate" media="print" title="Print View" href="SymlinkSupport%3Faction=print.html">
<link rel="Up" href="DevelopingVesta.html">
<link rel="Search" href="FindPage.html">
<link rel="Index" href="TitleIndex.html">
<link rel="Glossary" href="WordIndex.html">
<link rel="Help" href="HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr">

<div id="header">

<form id="searchform" method="get" action="SymlinkSupport.html">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="FrontPage.html"><img src="wiki/vesta/img/1line.png" alt="Vesta" height=44 width=202></a></div>
<div id="locationline">

<ul id="pagelocation">
<li><a href="DevelopingVesta.html">DevelopingVesta</a></li><li><a href="SymlinkSupport.html">SymlinkSupport</a></li>
</ul>

</div>
</div>

<div id="sidebar">
<div class="sidepanel">
<h1>Wiki</h1>

<ul id="navibar">
<li class="wikilink"><a href="RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a href="FindPage.html">FindPage</a></li><li class="wikilink"><a href="HelpContents.html">HelpContents</a></li><li class="current"><a href="SymlinkSupport.html">SymlinkSupport</a></li>
</ul>

</div>
<div class="sidepanel">
<h1>User</h1>
<ul id="username"><li><a href="SymlinkSupport%3Faction=login.html" id="login" rel="nofollow">Login</a></li></ul>
</div>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="SymlinkSupport.html#Introduction">Introduction</a></li><li>
<a href="SymlinkSupport.html#Functionality">Functionality</a><ol><li>
<a href="SymlinkSupport.html#Repository">Repository</a></li><li>
<a href="SymlinkSupport.html#Evaluator">Evaluator</a></li><li>
<a href="SymlinkSupport.html#Replication_agreement">Replication agreement</a></li><li>
<a href="SymlinkSupport.html#Appendable_Directories">Appendable Directories</a></li></ol></li><li>
<a href="SymlinkSupport.html#Concerns">Concerns</a><ol><li>
<a href="SymlinkSupport.html#If_symlinks_point_outside_an_immutable_version.2C_it.27s_not_really_immutable.21">If symlinks point outside an immutable version, it's not really immutable!</a></li><li>
<a href="SymlinkSupport.html#The_interpretation_of_symlinks_can_change_based_on_context">The interpretation of symlinks can change based on context</a></li><li>
<a href="SymlinkSupport.html#Symlinks_will_be_hard_to_deal_with_in_SDL">Symlinks will be hard to deal with in SDL</a></li></ol></li><li>
<a href="SymlinkSupport.html#Code_Changes">Code Changes</a><ol><li>
<a href="SymlinkSupport.html#Repository-1">Repository</a><ol><li>
<a href="SymlinkSupport.html#VestaSource::unused_-.3E_VestaSource::symlink">VestaSource::unused -&gt; VestaSource::symlink</a></li><li>
<a href="SymlinkSupport.html#Link_target_needs_a_new_VMemPool_type">Link target needs a new VMemPool type</a></li><li>
<a href="SymlinkSupport.html#Re-use_VLeaf.2C_or_add_a_new_VestaSource_sub-class.3F">Re-use VLeaf, or add a new VestaSource sub-class?</a></li><li>
<a href="SymlinkSupport.html#New_VestaSource_functions">New VestaSource functions</a></li><li>
<a href="SymlinkSupport.html#Replication">Replication</a></li><li>
<a href="SymlinkSupport.html#NFS_glue">NFS glue</a></li><li>
<a href="SymlinkSupport.html#VDirEvaluator">VDirEvaluator</a></li><li>
<a href="SymlinkSupport.html#VestaSource_member_functions.2Fvariables_for_symlinks">VestaSource member functions/variables for symlinks</a></li></ol></li><li>
<a href="SymlinkSupport.html#Evaluator-1">Evaluator</a><ol><li>
<a href="SymlinkSupport.html#A_run_tool_input">_run_tool input</a></li><li>
<a href="SymlinkSupport.html#A_run_tool_result">_run_tool result</a></li><li>
<a href="SymlinkSupport.html#Shipping">Shipping</a></li><li>
<a href="SymlinkSupport.html#files_clause">files clause</a></li><li>
<a href="SymlinkSupport.html#Primitive_functions">Primitive functions</a></li></ol></li><li>
<a href="SymlinkSupport.html#Other_Programs">Other Programs</a><ol><li>
<a href="SymlinkSupport.html#vcheckagreement">vcheckagreement</a></li></ol></li></ol></li><li>
<a href="SymlinkSupport.html#Possible_Problems">Possible Problems</a></li><li>
<a href="SymlinkSupport.html#Possible_Scope_Reductions">Possible Scope Reductions</a></li><li>
<a href="SymlinkSupport.html#Testing">Testing</a></li><li>
<a href="SymlinkSupport.html#Discussion">Discussion</a></li></ol></div> <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h1 id="Introduction">Introduction</h1>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">There are two kinds of support for symlinks that Vesta users would like to have: <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><ol type="1"><li>Support for tools that want to create symlinks or that want symlinks in their initial filesystem <span class="anchor" id="line-12"></span></li><li>Support for storing symlinks under version control along with files and directories <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ol><p class="line874">Neither of these are truly necessary, but they can be helpful. <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line874">Some complicated tools, especially ones developed in a non-Vesta context and then imported into Vesta, may expect to use symlinks.  This can sometimes be removed or worked around, and people have found some creative ways to do that.  It is however a burden on the person trying to make the tool work in Vesta. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span><p class="line874">Putting symlinks under version control can make it easier to store large file sets from other places.  There's no need for them if you're working purely in Vesta, but that's not always the case when interfacing with other development groups. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><p class="line874">There are two open tracker entries, one for each of these issues: <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><ul><li><p class="line891"><a class="https" href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1166276&amp;group_id=34164&amp;atid=410430">symlink in volatile directory</a> <span class="anchor" id="line-23"></span></li><li><p class="line891"><a class="https" href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1356578&amp;group_id=34164&amp;atid=410430">Versioning symlinks</a> <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span></li></ul><p class="line874">We could close one of them, because at this point we intend to implement end-to-end support for symlinks all at once. <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><p class="line867">
<h1 id="Functionality">Functionality</h1>
<span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line874">This section describes what functionality we plan to add. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line867">
<h2 id="Repository">Repository</h2>
<span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line862">Creating symlinks will be supported in mutable directories (i.e. checkout working copies under <tt>/vesta-work</tt>) and volatile directories (the temporary directories where tools run).  (Currently, attempting to create a symlink in either place will result in an error.) <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line874">An immutable snapshot taken of a working directory with a symlink will copy the symlink into the immutable directory.  The symlink itself will obviously be immutable, though no restriction will be placed on its target.  Users could shoot themselves in the foot a little with this if they don't pay attention, but only through the NFS interface to the repository. <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><p class="line874">The evaluator will be allowed to provide symlinks as part of the initial filesystem for a tool. <span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><p class="line867">
<h2 id="Evaluator">Evaluator</h2>
<span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><p class="line874">In SDL, a symlink will be represented as a singleton list containing a text value of the link target.  This avoids the need to introduce any new syntax or types or other significant changes. <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line862">If a tool creates a symlink, it will appear in the result binding as a singleton list.  For example, suppose the variable <tt>R</tt> contains the result of a <tt>_run_tool</tt> call which created the path <tt>/foo</tt> as a symlink to <tt>bar</tt>.  That would give us: <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line867"><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><pre><span class="anchor" id="line-1"></span>R = [ root = [ foo = &lt; &quot;bar&quot; &gt; ] ];</pre><span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line862">The same representation will be supported in <tt>./root</tt> when calling <tt>_run_tool</tt>.  For example, to create the same symlink before running a tool: <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line867"><span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><pre><span class="anchor" id="line-1-1"></span>. ++= [ root/foo = &lt;&quot;bar&quot;&gt; ];</pre><span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line862">The same representation will be used if a symlink is brought in from an immutable directory in the <tt>files</tt> clause.  For example, if the directory containing a model has a symlink named &quot;foo&quot; that points to &quot;bar&quot; then this files clause: <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line867"><span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><pre><span class="anchor" id="line-1-2"></span>files
<span class="anchor" id="line-2"></span>  foo;</pre><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line874">Would be the same as this assignment: <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><p class="line867"><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><pre><span class="anchor" id="line-1-3"></span>foo = &lt;&quot;bar&quot;&gt;;</pre><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line874">When shipping the result of an evaluation, a singleton list will create a symlink in the target directory. <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line874">Some new primitive functions will be added to make dealing with symlinks a little easier. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line867">
<h2 id="Replication_agreement">Replication agreement</h2>
<span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line874">Introducing a new type of object that can exist in the appendable portion of the repository means that we need to specify when two replicas of an object agree or don't agree. <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">A symlink inside an immutable directory will agree with a replica as long as both have the same link target text.  The link target is the only information stored for a symlink, so there's really nothing else to compare.  <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line867">
<h2 id="Appendable_Directories">Appendable Directories</h2>
<span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line874">We won't allow the new symlink type in appendable directories.  stubs with symlionk-to attributes can be used there. <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line874">This is mainly to avoid complicating the notion of replication agreement of having to modify client programs to deal with symlinks in appendable directories. <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line867">
<h1 id="Concerns">Concerns</h1>
<span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><p class="line867">
<h2 id="If_symlinks_point_outside_an_immutable_version.2C_it.27s_not_really_immutable.21">If symlinks point outside an immutable version, it's not really immutable!</h2>
<span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line874">It might appear that way if you just access the files through the NFS interface.  However, a symlink in an immutable directory cannot have its link target changed.  So it would be immutable. <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><p class="line874">If we support versioning symlinks at all, there's a risk of users making trouble for themselves (and other users) with symlinks.  We don't think it fundamentally breaks Vesta or violates its guarantees. <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><p class="line867">
<h2 id="The_interpretation_of_symlinks_can_change_based_on_context">The interpretation of symlinks can change based on context</h2>
<span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><p class="line874">The same immutable version can appear in multiple places (i.e. in a vadvanced snapshot and a checked-in version).  That means a relative symlink hat uses &quot;..&quot; could point two different places from the same immutable version.  Symlinks with &quot;..&quot; are something users should probably avoid. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line874">The same goes for symlinks represented as singleton lists in a binding structure in SDL.  If you move a binding around, relative symlinks could point somewhere else.  Absolute symlinks are probably just as dangerous in SDL as relative ones with &quot;..&quot;. <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line867">
<h2 id="Symlinks_will_be_hard_to_deal_with_in_SDL">Symlinks will be hard to deal with in SDL</h2>
<span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><p class="line862">Suppose one piece of SDL code puts a directory and a symlink to it into <tt>./root</tt>: <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><p class="line867"><span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><pre><span class="anchor" id="line-1-4"></span>. ++= [ root = [ foo = [ ... ],
<span class="anchor" id="line-2-1"></span>                 bar = &lt;&quot;foo&quot;&gt; ] ];</pre><span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line862">Suppose some other piece of SDL code (perhaps far away in another function defined in a different SDL model) tries to put something into the directory &quot;<tt>/bar</tt>&quot; that's really a symlink: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line867"><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><pre><span class="anchor" id="line-1-5"></span>. ++= [ root/bar/x = ... ];</pre><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><p class="line874">Given the semantics of the ++ operator, that will replace what used to be a symlink to a directory with a completely separate directory. <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span><p class="line874">The semantics of the ++ operator can't be changed to handle symlinks.  Doing so would change the meaning of existing SDL code.  If users need to merge two bindings and want symlinks to be followed in a manner consistent with UNIX filesystem semantics, they'll need to use something other than ++. <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span><p class="line874">The binding lookup operator (/) could also be a problem when a binding contains singleton lists representing symlinks. <span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span><p class="line874">We'll add new primitive functions to help with these problems.  We will not change existing syntax or semantics to help with symlinks. <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><p class="line867">
<h1 id="Code_Changes">Code Changes</h1>
<span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><p class="line867">
<h2 id="Repository-1">Repository</h2>
<span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><p class="line867">
<h3 id="VestaSource::unused_-.3E_VestaSource::symlink">VestaSource::unused -&gt; VestaSource::symlink</h3>
<span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><p class="line862">The type of a directory entry in the repository is represented by a value from the enum <tt>VestaSource::typeTag</tt>.  There's only one unused value, and that will become the value used to represent a symlink. <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><p class="line874">This will require some care to make sure that the packed in-memory representation doesn't get confused with the special byte 0xff used to mark the end of a block of directory entries.  (See the isEndMark member function in the VDirChangeable class.)  We need to be careful to avoid setting all of the master, hasEFPTag, and sameAsBase flags.  (The inUse flag is used internally during the repository's directory structure garbage collection which happens during weeding.)  This can be implemented with a check in VDirChangeable::appendEntry.  hasEFPTag shouldn't be needed, and since symlinks can only be deleted and replaced (not modified), sameAsBase should be avoidable too. <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span><p class="line867">
<h3 id="Link_target_needs_a_new_VMemPool_type">Link target needs a new VMemPool type</h3>
<span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><p class="line874">The link target is just a string.  It should be stored in the repository's memory.  There's not really any place to put it in the packed representation of a directory, though there is room for one additional 32-bit number (in the &quot;value&quot; slot used to hold the shortid for files and a VMemPool short pointer for directories). <span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><p class="line874">The value field of a symlink directory entry could be a short pointer to another VMemPool block containing the link target.  However, because of the way the repository's VMemPool system works, we can't simply allocate a block and stick a string in it.  (Each block must have a type which is used for the repository's mark/sweep garbage collection of its memory pool during weeding.  See src/VMemPool.H in the repository package.)  We would have to add a new VMemPool block type to hold the link target.  Since the block type would be very simple this wouldn't be too hard, but it would require registering new callbacks for the block type with VMemPool. <span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span><p class="line874">We don't have to store symlinks in VMemPool, but it would be easiest to do so.  Storing it in some other data structure would require that we make checkpoint that data structure. <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line867">
<h3 id="Re-use_VLeaf.2C_or_add_a_new_VestaSource_sub-class.3F">Re-use VLeaf, or add a new VestaSource sub-class?</h3>
<span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line862">The VLeaf class (a sub-class of <a href="../VestaSource.html">VestaSource</a>) is currently used inside the repository server to represent files (both mutable and immutable), stubs, ghosts, and devices (which are only supported in volatile directories).  We could further overload it to handle symlinks as well, or we could add a new sub-class.  Symlinks would require adding two new member variables which would go unused for the other types (symlink target string and timestamp), and the current VLeaf member variables will go unused for symlinks.  That suggests that a new <a href="../VestaSource.html">VestaSource</a> sub-class would be a good idea. <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><p class="line862">(This only affects the server side.  All <a href="../VestaSource.html">VestaSource</a> objects in repository client programs use the VDirSurrogate class.) <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><p class="line867">
<h3 id="New_VestaSource_functions">New VestaSource functions</h3>
<span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><p class="line862">These new functions will be declared virtual in the <a href="../VestaSource.html">VestaSource</a>. <span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><ul><li><p class="line891"><tt>VestaSource::readlink</tt> get the target string of a symlink <span class="anchor" id="line-150"></span><ul><li>Implementation needed in VDirChangeable, VDirSurrogate, and VDirEvaluator <span class="anchor" id="line-151"></span></li></ul></li><li><p class="line891"><tt>VestaSource::insertSymlink</tt> create a symlink in a directory <span class="anchor" id="line-152"></span><ul><li>Implementation needed in VDirChangeable, VDirSurrogate <span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span></li></ul></li></ul><p class="line867">
<h3 id="Replication">Replication</h3>
<span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span><p class="line862">Replication code will need changes to handle symlinks in immutable directories.  Specifically, ReplicateImmDirCallback in Replicate.C would need to handle the new symlink type. <span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><p class="line867">
<h3 id="NFS_glue">NFS glue</h3>
<span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><p class="line874">The do_symlink code in glue.C would need to be changed to create new-style symlinks in mutable directories and volatile directories. <span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span><p class="line874">The any_fattr code in glue.C would need to be changed to handle new-style symlinks. <span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span><p class="line867">
<h3 id="VDirEvaluator">VDirEvaluator</h3>
<span class="anchor" id="line-165"></span><span class="anchor" id="line-166"></span><p class="line874">The repository side of the network protocol for representing evaluator directories will need to be changed. <span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span><p class="line874">The file Evaluator_Dir_SRPC.H defines and documents the network protocol. <span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span><p class="line867">
<h3 id="VestaSource_member_functions.2Fvariables_for_symlinks">VestaSource member functions/variables for symlinks</h3>
<span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span><p class="line862">What should some of the member functions of a <a href="../VestaSource.html">VestaSource</a> representing a symlink do? <span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span><ul><li><p class="line891"><tt>shortId</tt> should return NullShortId <span class="anchor" id="line-175"></span></li><li><p class="line891"><tt>timestamp</tt> should return the timestamp of the enclosing directory.  This is a bit of a fudge, but avoids the need to store a timestamp for each symlink. <span class="anchor" id="line-176"></span></li><li><p class="line891"><tt>executable</tt> should return <tt>false</tt>.  (This doesn't need to have any effect on the permissions of a symlink manifested through the NFS interface.) <span class="anchor" id="line-177"></span><span class="anchor" id="line-178"></span></li></ul><p class="line862">That should the value of the <tt>fptag</tt> member variable be for a symlink? <span class="anchor" id="line-179"></span><span class="anchor" id="line-180"></span><p class="line867">
<h2 id="Evaluator-1">Evaluator</h2>
<span class="anchor" id="line-181"></span><span class="anchor" id="line-182"></span><p class="line867">
<h3 id="A_run_tool_input">_run_tool input</h3>
<span class="anchor" id="line-183"></span><span class="anchor" id="line-184"></span><p class="line862">The ToolDirectoryServer will need to be changed to respond with a symlink type when a path is requested that has a singleton list for its value. <span class="anchor" id="line-185"></span><span class="anchor" id="line-186"></span><p class="line867">
<h3 id="A_run_tool_result">_run_tool result</h3>
<span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><p class="line867">AddToNewStuff in PrimRunTool.C needs to be modified to handle symlinks created by the tool. <span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><p class="line867">
<h3 id="Shipping">Shipping</h3>
<span class="anchor" id="line-191"></span><span class="anchor" id="line-192"></span><p class="line867">ShipValue in VASTi.C needs to be modified to allow shipping a singleton list containing a text as a symlink. <span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span><p class="line867">
<h3 id="files_clause">files clause</h3>
<span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><p class="line874">FileEC in Expr.C will need to modified to support symlinks brought in from immutable directories. <span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><p class="line867"><span class="anchor" id="sdl_primitive_funcs"></span> <span class="anchor" id="line-199"></span>
<h3 id="Primitive_functions">Primitive functions</h3>
<span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span><p class="line874">Two new SDL primitive functions: <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><ul><li>Like ++ but follow symlinks in a filesystem-like way <span class="anchor" id="line-204"></span></li><li>Lookup a path following symlinks <span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span></li></ul><p class="line867">
<h2 id="Other_Programs">Other Programs</h2>
<span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><p class="line867">
<h3 id="vcheckagreement">vcheckagreement</h3>
<span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><p class="line874">The vcheckagreement utility will need to handle symlinks in immutable directories. <span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span><p class="line867">
<h1 id="Possible_Problems">Possible Problems</h1>
<span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><p class="line874">Both server-side and client-side code which lists directories may need changes to handle the symlink directory entry type.  Some functions that may need attention: <span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><ul><li><p class="line891"><tt>VestaSource::makeFilesImmutable</tt> <span class="anchor" id="line-217"></span></li><li><p class="line891"><tt>VDirChangeable::freeTree</tt> <span class="anchor" id="line-218"></span></li><li><p class="line891"><tt>ReposUI::changed</tt> <span class="anchor" id="line-219"></span></li><li><p class="line891"><tt>ReposUI::cleanup</tt> <span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span></li></ul><p class="line867">
<h1 id="Possible_Scope_Reductions">Possible Scope Reductions</h1>
<span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><p class="line874">Allowing symlinks in volatile/evaluator directories is the minimum we really need to support, as that's where it's most problematic.  That requires: <span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span><ul><li>VDirChangeable modifications <span class="anchor" id="line-226"></span></li><li>NFS glue code changes <span class="anchor" id="line-227"></span></li><li><p class="line891">ToolDirectoryServer and VDirEvaluator modifications <span class="anchor" id="line-228"></span></li><li><p class="line891">PrimRunTool changes <span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span></li></ul><p class="line874">There are some things we could get away with not adding, but they would be obvious holes: <span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><ul><li>Don't allow symlinks in mutable/immutable directories <span class="anchor" id="line-233"></span><ul><li>No need to support them in the SDL files caluse <span class="anchor" id="line-234"></span></li><li>No replication support needed <span class="anchor" id="line-235"></span></li></ul></li><li>Don't support shipping symlinks <span class="anchor" id="line-236"></span></li><li>Don't add new SDL primitive functions <span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span></li></ul><p class="line874">These don't seem like significant scope reductions.  It seems like it would be better to implement symlink support all at once. <span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><p class="line867">
<h1 id="Testing">Testing</h1>
<span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span><p class="line874">Some cases we will need to test: <span class="anchor" id="line-243"></span><span class="anchor" id="line-244"></span><ul><li>Creating a symlink in a mutable directory <span class="anchor" id="line-245"></span></li><li>Taking a snapshot of a mutable directory containing a symlink <span class="anchor" id="line-246"></span></li><li><p class="line862">SDL <tt>files</tt> clause that brings in a symlink from an immutable directory <span class="anchor" id="line-247"></span></li><li>Providing a symlink in the initial filesystem for a tool <span class="anchor" id="line-248"></span><ul><li>Tool accesses the linked-to object <span class="anchor" id="line-249"></span></li><li>Tool accesses the symlink with lstat or readlink but never accesses the linked-to object <span class="anchor" id="line-250"></span></li></ul></li><li>Tool that creates a symlink <span class="anchor" id="line-251"></span></li><li>Using the new primitive functions <span class="anchor" id="line-252"></span><ul><li>With symlinks in the input binding <span class="anchor" id="line-253"></span></li><li>Without symlinks in the input binding <span class="anchor" id="line-254"></span></li></ul></li><li>Shipping a symlink <span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span></li></ul><p class="line867">
<h1 id="Discussion">Discussion</h1>
<span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><p class="line862">If you have questions or comments about this, please use the <a href="SymlinkSupport/Discussion.html">/Discussion</a> sub-page.  (That way we can keep the dicussion separate from the plans.) <span class="anchor" id="line-259"></span><span class="anchor" id="bottom"></span></div>
<div id="pagebottom"></div>
</div>


<div id="footer">
<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>
</html>

