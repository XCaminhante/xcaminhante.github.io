<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="robots" content="index,nofollow">

<title>BalancedCallTree - Vesta Wiki</title>
<script type="text/javascript" src="moin_static199/common/js/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="moin_static199/vesta/css/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="moin_static199/vesta/css/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="moin_static199/vesta/css/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="moin_static199/vesta/css/projection.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="moin_static199/vesta/css/msie.css">
<![endif]-->


<link rel="alternate" title="Vesta Wiki: BalancedCallTree" href="BalancedCallTree?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=BalancedCallTree&amp;ddiffs=1.html" type="application/rss+xml">


<link rel="Start" href="FrontPage.html">
<link rel="Alternate" title="Wiki Markup" href="BalancedCallTree?action=raw.html">
<link rel="Alternate" media="print" title="Print View" href="BalancedCallTree?action=print.html">
<link rel="Appendix" title="autogenerated-09b090c6b52a76bfd940481a377f6ab9c1b5120e.png" href="BalancedCallTree?action=AttachFile&amp;do=view&amp;target=autogenerated-09b090c6b52a76bfd940481a377f6ab9c1b5120e.png">
<link rel="Appendix" title="autogenerated-9ca7da67e9503c3650bc157d6a5149650fcf1d3a.png" href="BalancedCallTree?action=AttachFile&amp;do=view&amp;target=autogenerated-9ca7da67e9503c3650bc157d6a5149650fcf1d3a.png">
<link rel="Appendix" title="autogenerated-d9580e399112301c5e5a2eaa07b57c45b6735269.png" href="BalancedCallTree?action=AttachFile&amp;do=view&amp;target=autogenerated-d9580e399112301c5e5a2eaa07b57c45b6735269.png">
<link rel="Appendix" title="autogenerated-f001e82cf9715a51d88cfff96ec9bf091be0118c.png" href="BalancedCallTree?action=AttachFile&amp;do=view&amp;target=autogenerated-f001e82cf9715a51d88cfff96ec9bf091be0118c.png">
<link rel="Appendix" title="delete.me.to.regenerate.images" href="BalancedCallTree?action=AttachFile&amp;do=view&amp;target=delete.me.to.regenerate.images.html">
<link rel="Search" href="FindPage.html">
<link rel="Index" href="TitleIndex.html">
<link rel="Glossary" href="WordIndex.html">
<link rel="Help" href="HelpOnFormatting.html">
</head>

<body  lang="en" dir="ltr">

<div id="header">

<form id="searchform" method="get" action="BalancedCallTree.html">
<div>
<input type="hidden" name="action" value="fullsearch">
<input type="hidden" name="context" value="180">
<label for="searchinput">Search:</label>
<input id="searchinput" type="text" name="value" value="" size="20"
    onfocus="searchFocus(this)" onblur="searchBlur(this)"
    onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search">
<input id="titlesearch" name="titlesearch" type="submit"
    value="Titles" alt="Search Titles">
<input id="fullsearch" name="fullsearch" type="submit"
    value="Text" alt="Search Full Text">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="FrontPage.html"><img src="wiki/vesta/img/1line.png" alt="Vesta" height=44 width=202></a></div>
<div id="locationline">

<ul id="pagelocation">
<li><a href="BalancedCallTree.html">BalancedCallTree</a></li>
</ul>

</div>
</div>

<div id="sidebar">
<div class="sidepanel">
<h1>Wiki</h1>

<ul id="navibar">
<li class="wikilink"><a href="RecentChanges.html">RecentChanges</a></li><li class="wikilink"><a href="FindPage.html">FindPage</a></li><li class="wikilink"><a href="HelpContents.html">HelpContents</a></li><li class="current"><a href="BalancedCallTree.html">BalancedCallTree</a></li>
</ul>

</div>
<div class="sidepanel">
<h1>User</h1>
<ul id="username"><li><a href="BalancedCallTree?action=login.html" id="login" rel="nofollow">Login</a></li></ul>
</div>
</div>

<div id="page" lang="en" dir="ltr">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="BalancedCallTree.html#Costs_of_Cached_Function_Calls">Costs of Cached Function Calls</a></li><li>
<a href="BalancedCallTree.html#Optimizing_the_Common_Case_with_Balanced_Call_Trees">Optimizing the Common Case with Balanced Call Trees</a></li><li>
<a href="BalancedCallTree.html#Examples">Examples</a></li></ol></div> <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line867">
<h1 id="Costs_of_Cached_Function_Calls">Costs of Cached Function Calls</h1>
<span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line874">Every time the SDL code in a Vesta build calls a cached function, a lookup is performed to the Vesta cache server.  Unfortunately, cache lookups are not free.  They take time, network bandwidth, CPU resources on the client evaluating the build, and CPU and I/O resources on the server running the cache daemon.  So it's a good idea to optimize them out when possible. <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line867">
<h1 id="Optimizing_the_Common_Case_with_Balanced_Call_Trees">Optimizing the Common Case with Balanced Call Trees</h1>
<span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line862">Suppose you have a function that takes in a list of files to process.  Each one will be processed by calling another cached function (perhaps just <tt>_run_tool</tt>).  Imagine a build that calls this function with a list of 100 files.  As a user is working, suppose they have changed just one file since the last time they built.  What cache lookups would be performed and what would be their result?  Or to put it another way, what would the call tree of cached functions look like? <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line874">We would cache miss on our function that takes a list of 100 files.  We would then perform 100 cache lookups, 99 of which would be cache hits and one of which would be a cache miss (for the single file that the user edited since they last built).  Here's a graphical representation of this rather simple and flat call tree: <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line867"><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><img src="BalancedCallTree%3Faction=AttachFile&amp;do=get&amp;target=autogenerated-f001e82cf9715a51d88cfff96ec9bf091be0118c.png" /><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line867"><span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><img src="BalancedCallTree%3Faction=AttachFile&amp;do=get&amp;target=autogenerated-d9580e399112301c5e5a2eaa07b57c45b6735269.png" /><span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line874">That's 101 cache lookups total.  This seems like a lot for changing one file.  If we could eliminate some of them, the build will complete faster while using less resources on both the client and the server. <span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span><p class="line862">Luckily there's a simple <em>divide and conquer</em> technique we can use to improve this situation called <em>balanced call trees</em>.  When our function to process multiple files is called, we'll first check to see how many files were supplied.  If more than a small number of files were passed to our function, we'll divide them in half and call our function recursively with the two halves. <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><p class="line874">Suppose we chose to divide the files up if there were more than 10 of them.  With 100 files we would divide them in half until we reached groups of 6-7 files each.  Now our call tree looks like this: <span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line867"><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><img src="BalancedCallTree%3Faction=AttachFile&amp;do=get&amp;target=autogenerated-9ca7da67e9503c3650bc157d6a5149650fcf1d3a.png" /><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line874">Now instead of 101 cache lookups, we have just 16.  That's a significant improvement.  The user should definitely notice the improvement in run-time. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><p class="line862">Of course if most of the 100 files are modified or if the whole build is a cache miss, this method could result in <strong>more</strong> cache lookups than before.  However we're trying to optimize for the common case of a user working in the normal edit-build cycle. <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><p class="line867">
<h1 id="Examples">Examples</h1>
<span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span><p class="line862">There are two key examples of this technique in the <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/bridges/generics">/vesta/vestasys.org/bridges/generics</a>: <span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><ul><li><p class="line891"><tt>./generic/compile</tt> implements exactly what's described above.  It's used by <a class="http" href="http://pub.vestasys.org/cgi-bin/vestaweb?path=/vesta/vestasys.org/bridges/c_like">the c_like bridge</a> for compiling C/C++ source files. <span class="anchor" id="line-107"></span></li><li><p class="line891"><tt>./generic/map</tt> and <tt>./generic/par_map</tt> act like the primitive functions <tt>_map</tt> and <tt>_par_map</tt>, but with caching using balanced call trees.  <span class="anchor" id="line-108"></span></li></ul><span class="anchor" id="bottom"></span></div>
<div id="pagebottom"></div>
</div>


<div id="footer">
<ul id="credits">
<li><a href="http://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="http://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li><a href="http://moinmo.in/GPL" title="MoinMoin is GPL licensed.">GPL licensed</a></li><li><a href="http://validator.w3.org/check?uri=referer" title="Click here to validate this page.">Valid HTML 4.01</a></li>
</ul>


</div>
</body>
</html>

